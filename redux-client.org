#+SEQ_TODO: TODAY TOMORROW TEST DONE
* DONE What You Will Need
#+BEGIN: clocktable :maxlevel 4 :scope subtree
#+CAPTION: Clock summary at [2015-11-24 মঙ্গল 21:33]
| Headline                 | Time   |
|--------------------------+--------|
| *Total time*             | *0:22* |
|--------------------------+--------|
| TODAY What You Will Need | 0:22   |
#+END:

  CLOCK: [2015-11-24 মঙ্গল 09:52]--[2015-11-24 মঙ্গল 10:02] =>  0:10
  CLOCK: [2015-11-24 মঙ্গল 09:38]--[2015-11-24 মঙ্গল 09:50] =>  0:12
  :PROPERTIES:
  :Effort:   0:13
  :END:
** http://teropa.info/blog/2015/09/10/full-stack-redux-tutorial.html
** Install following packages 
*** DONE Node
    CLOSED: [2015-11-24 মঙ্গল 09:37]
#+BEGIN_SRC sh 
node -v 
#+END_SRC

#+RESULTS:
: v4.2.1
*** DONE ES6
*** React
*** Webpack
*** and Babel
** TOMORROW For good introduction we need to take a look at [[http://survivejs.com/][SurviveJS]]
* The App 
** We'll be developing an application for organizing live votes 
*** for parties, conferences, meetings, and other gatherings of people.
** For example, here's how a vote on the best Danny Boyle film
could go:
The app puts entries against each other in pairs, until a winner is found. 

** The app will have two separate user interfaces: The voting UI
can be used on a mobile device, or anything else that has a
web browser. The results UI is designed to be beamed on a
projector or some other large screen. It'll show the results
of the running vote in real time.

* The Architecture 
** The system will technically consist of two applications:
There's a browser app we'll make with React that provides
both the user interfaces, and a server app we'll make for
Node that handles the voting logic. Communication between the
two will be done using WebSockets.
** We're going to use Redux to organize the application code
both on the client and on the server. For holding the state
we'll use Immutable data structures.

** Even though there'll be a lot of similarity between the
client and server - both will use Redux, for example - this
isn't really a universal/isomorphic application and the two
won't actually share any code. 

* The Server Application 
** Description
***  We're going to write the Node application first and the React application after that. This will let us concentrate on the core logic before we start thinking about the UI.
*** As we create the server app, we'll get acquainted with Redux and Immutable, and will see how an application built with them holds together. Redux is most often associated with React applications, but it really isn't limited to that use case. Part of what we're going to learn is how useful Redux can be in other contexts as well!
** Designing The Application State Tree 
*** Designing a Redux app often begins by thinking about the application state data structure. This is what describes what's going on in your application at any given time.
*** All kinds of frameworks and architectures have state. 
**** In Ember apps and Backbone apps, state is in Models. 
**** In Angular apps, state is often in Factories and Services. 
**** In most Flux implementations, it is in Stores. 
**** How does Redux differ from these
***** The main difference is that in Redux.
***** the application state is all stored in one single tree structure. In other words, everything there is to know
about your application's state is stored in one data structure formed out
of maps and arrays.

** Project Setup
*** DONE This results in a directory with the single file "package.json" in it.
#+BEGIN_SRC sh
npm init -y
#+END_SRC
    
#+RESULTS:
*** DONE Install ES6, Mocha, Cha 
#+BEGIN_SRC sh
npm install --save-dev babel-core babel-cli babel-preset-es2015
npm install --save-dev mocha chai
#+END_SRC

#+RESULTS:
| babel-core@6.1.20          | node_modules/babel-core                                     |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | slash@1.0.0                                                 |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | shebang-regex@1.0.0                                         |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | path-exists@1.0.0                                           |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | path-is-absolute@1.0.0                                      |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-messages@6.1.18                                       |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-template@6.1.18                                       |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | private@0.1.6                                               |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-helpers@6.1.20                                        |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | esutils@2.0.2                                               |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | convert-source-map@1.1.2                                    |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | home-or-tmp@1.0.0                                           | (os-tmpdir@1.0.1,                            | user-home@1.1.1)                              |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | source-map@0.5.3                                            |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | debug@2.2.0                                                 | (ms@0.7.1)                                   |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babylon@6.1.20                                              |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-types@6.1.18                                          | (to-fast-properties@1.0.1)                   |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | minimatch@2.0.10                                            | (brace-expansion@1.1.1)                      |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-code-frame@6.1.18                                     | (js-tokens@1.0.2,                            | line-numbers@0.2.0,                           | chalk@1.1.1,                        | repeating@1.1.3)                   |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-generator@6.1.20                                      | (trim-right@1.0.1,                           | repeating@1.1.3,                              | is-integer@1.0.6,                   | detect-indent@3.0.1)               |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-traverse@6.1.20                                       | (globals@8.12.0,                             | repeating@1.1.3,                              | invariant@2.1.2)                    |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | source-map-support@0.2.10                                   | (source-map@0.1.32)                          |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | json5@0.4.0                                                 |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | regenerator@0.8.35                                          | (through@2.3.8,                              | esprima-fb@15001.1.0-dev-harmony-fb,          | recast@0.10.24,                     | commoner@0.10.4,                   | defs@1.1.1)            |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | lodash@3.10.1                                               |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-register@6.1.18                                       | (core-js@1.2.6)                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| └──                        | babel-runtime@5.8.34                                        | (core-js@1.2.6)                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
|                            |                                                             |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| babel-cli@6.1.18           | node_modules/babel-cli                                      |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | slash@1.0.0                                                 |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | path-exists@1.0.0                                           |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | fs-readdir-recursive@0.1.2                                  |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | path-is-absolute@1.0.0                                      |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | log-symbols@1.0.2                                           |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | convert-source-map@1.1.2                                    |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | v8flags@2.0.10                                              | (user-home@1.1.1)                            |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | commander@2.9.0                                             | (graceful-readlink@1.0.1)                    |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | source-map@0.5.3                                            |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | chalk@1.1.1                                                 | (escape-string-regexp@1.0.3,                 | supports-color@2.0.0,                         | ansi-styles@2.1.0,                  | has-ansi@2.0.0,                    | strip-ansi@3.0.0)      |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | glob@5.0.15                                                 | (inherits@2.0.1,                             | once@1.3.2,                                   | inflight@1.0.4,                     | minimatch@3.0.0)                   |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | output-file-sync@1.1.1                                      | (xtend@4.0.1,                                | mkdirp@0.5.1)                                 |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | request@2.65.0                                              | (aws-sign2@0.6.0,                            | forever-agent@0.6.1,                          | tunnel-agent@0.4.1,                 | oauth-sign@0.8.0,                  | caseless@0.11.0,       | stringstream@0.0.5,             | isstream@0.1.2,        | json-stringify-safe@5.0.1, | extend@3.0.0,         | tough-cookie@2.2.1, | qs@5.2.0, | node-uuid@1.4.6, | combined-stream@1.0.5, | mime-types@2.1.7, | form-data@1.0.0-rc3, | http-signature@0.11.0, | hawk@3.1.1, | bl@1.0.0, | har-validator@2.0.2) |
| ├──                        | chokidar@1.2.0                                              | (arrify@1.0.0,                               | glob-parent@2.0.0,                            | async-each@0.1.6,                   | is-glob@2.0.1,                     | is-binary-path@1.0.1,  | lodash.flatten@3.0.2,           | readdirp@2.0.0,        | anymatch@1.3.0)            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | bin-version-check@2.1.0                                     | (semver-truncate@1.0.0,                      | minimist@1.2.0,                               | semver@4.3.6,                       | bin-version@1.0.4)                 |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | lodash@3.10.1                                               |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-register@6.1.18                                       | (home-or-tmp@1.0.0,                          | source-map-support@0.2.10,                    | core-js@1.2.6)                      |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-polyfill@6.1.19                                       | (regenerator@0.8.42,                         | core-js@1.2.6)                                |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| └──                        | babel-runtime@5.8.34                                        | (core-js@1.2.6)                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
|                            |                                                             |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| babel-preset-es2015@6.1.18 | node_modules/babel-preset-es2015                            |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-shorthand-properties@6.1.18   | (babel-types@6.1.18,                         | babel-runtime@5.8.34)                         |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-arrow-functions@6.1.18        | (babel-runtime@5.8.34)                       |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-template-literals@6.1.18      | (babel-runtime@5.8.34)                       |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-literals@6.1.18               | (babel-runtime@5.8.34)                       |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-block-scoped-functions@6.1.18 | (babel-runtime@5.8.34)                       |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-typeof-symbol@6.1.18          | (babel-runtime@5.8.34)                       |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-spread@6.1.18                 | (babel-runtime@5.8.34)                       |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-destructuring@6.1.18          | (babel-runtime@5.8.34)                       |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-check-es2015-constants@6.1.18                  | (babel-runtime@5.8.34)                       |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-for-of@6.1.18                 | (babel-runtime@5.8.34)                       |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-block-scoping@6.1.18          | (babel-types@6.1.18,                         | babel-template@6.1.18,                        | babel-traverse@6.1.20,              | lodash@3.10.1,                     | babel-runtime@5.8.34)  |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-function-name@6.1.18          | (babel-types@6.1.18,                         | babel-helper-function-name@6.1.18,            | babel-runtime@5.8.34)               |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-object-super@6.1.18           | (babel-helper-replace-supers@6.1.18,         | babel-runtime@5.8.34)                         |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-computed-properties@6.1.18    | (babel-template@6.1.18,                      | babel-helper-define-map@6.1.18,               | babel-runtime@5.8.34)               |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-sticky-regex@6.1.18           | (babel-helper-regex@6.1.18,                  | babel-types@6.1.18,                           | babel-runtime@5.8.34)               |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-unicode-regex@6.1.18          | (regexpu@1.3.0,                              | babel-helper-regex@6.1.18,                    | babel-runtime@5.8.34)               |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-parameters@6.1.18             | (babel-helper-get-function-arity@6.1.18,     | babel-helper-call-delegate@6.1.18,            | babel-template@6.1.18,              | babel-types@6.1.18,                | babel-traverse@6.1.20, | babel-runtime@5.8.34)           |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-modules-commonjs@6.1.20       | (babel-plugin-transform-strict-mode@6.1.18,  | babel-template@6.1.18,                        | babel-types@6.1.18,                 | babel-runtime@5.8.34)              |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | babel-plugin-transform-es2015-classes@6.1.20                | (babel-messages@6.1.18,                      | babel-helper-optimise-call-expression@6.1.18, | babel-helper-replace-supers@6.1.18, | babel-helper-function-name@6.1.18, | babel-template@6.1.18, | babel-helper-define-map@6.1.18, | babel-types@6.1.18,    | babel-traverse@6.1.20,     | babel-runtime@5.8.34) |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| └──                        | babel-plugin-transform-regenerator@6.1.18                   | (babel-plugin-syntax-async-functions@6.1.18, | private@0.1.6,                                | through@2.3.8,                      | babylon@6.1.20,                    | commoner@0.10.4,       | babel-types@6.1.18,             | babel-traverse@6.1.20, | babel-runtime@5.8.34)      |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| chai@3.4.1                 | node_modules/chai                                           |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | assertion-error@1.0.1                                       |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | type-detect@1.0.0                                           |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| └──                        | deep-eql@0.1.3                                              | (type-detect@0.1.1)                          |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
|                            |                                                             |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| mocha@2.3.3                | node_modules/mocha                                          |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | escape-string-regexp@1.0.2                                  |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | commander@2.3.0                                             |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | diff@1.4.0                                                  |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | supports-color@1.2.0                                        |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | growl@1.8.1                                                 |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | debug@2.0.0                                                 | (ms@0.6.2)                                   |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | mkdirp@0.5.0                                                | (minimist@0.0.8)                             |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| ├──                        | glob@3.2.3                                                  | (inherits@2.0.1,                             | graceful-fs@2.0.3,                            | minimatch@0.2.14)                   |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
| └──                        | jade@0.26.3                                                 | (commander@0.6.1,                            | mkdirp@0.3.0)                                 |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
|                            |                                                             |                                              |                                               |                                     |                                    |                        |                                 |                        |                            |                       |                     |           |                  |                        |                   |                      |                        |             |           |                      |
*** DONE tests with mocha command 
#+BEGIN_SRC sh
mkdir test
./node_modules/mocha/bin/mocha --compilers js:babel-core/register --recursive
#+END_SRC

#+RESULTS:
|                 |
|                 |
| 0 passing (3ms) |
*** DONE Place the command in package.json
package.json
"scripts": {
  "test": "mocha --compilers js:babel-core/register --recursive"
},
*** DONE Another thing we need to do is enable Babel's ES6/ES2015 language support. It's
done by activating the babel-preset-es2015 package that we already installed.
We just need to add a "babel" section to package.json:

package.json
"babel": {
  "presets": ["es2015"]
}
*** DONE test npm 
#+BEGIN_SRC sh
npm run test
#+END_SRC

#+RESULTS:
|   |                     |             |                                          |             |
| > | voting-server@1.0.0 | test        | /usr/local/src/jstutorials/voting-server |             |
| > | mocha               | --compilers | js:babel-core/register                   | --recursive |
|   |                     |             |                                          |             |
|   |                     |             |                                          |             |
|   |                     |             |                                          |             |
| 0 | passing             | (3ms)       |                                          |             |
|   |                     |             |                                          |             |

*** DONE Add immutability 
One of the first libraries we're going to be using is Facebook's Immutable,
which provides a number of data structures for us to use. We're going to start
discussing Immutable in the next section, but for now let's just add it to the
project, along with the chai-immutable library that extends Chai to add support
for comparing Immutable data structures:

#+BEGIN_SRC sh
npm install --save immutable
npm install --save-dev chai-immutable

#+END_SRC

#+RESULTS:
| immutable@3.7.5      | node_modules/immutable      |
| chai-immutable@1.5.2 | node_modules/chai-immutable |
*** We need to let plug in chai-immutable before any tests are run.
**** DONE Add test/test_helper.js
#+BEGIN_SRC js :tangle test/test_helper.js
import chai from 'chai';
import chaiImmutable from 'chai-immutable';

chai.use(chaiImmutable);

#+END_SRC
**** Modify package.json
"scripts": {
  "test": "mocha --compilers js:babel-core/register --require ./test/test_helper.js  --recursive",
  "test:watch": "npm run test -- --watch"
},

** Getting Comfortable With Immutable				  :IMMUTABLE:
   CLOCK: [2015-11-24 মঙ্গল 11:17]--[2015-11-24 মঙ্গল 12:44] =>  1:27
#+BEGIN: clocktable :maxlevel 3 :scope subtree
#+CAPTION: Clock summary at [2015-11-24 মঙ্গল 21:34]
| Headline                                        | Time   |      |      |
|-------------------------------------------------+--------+------+------|
| *Total time*                                    | *2:27* |      |      |
|-------------------------------------------------+--------+------+------|
| \emsp Getting Comfortable With Immutable        |        | 2:27 |      |
| \emsp\emsp Immutable data structures are the... |        |      | 1:00 |
#+END:

   :PROPERTIES:
   :Effort:   1:40
   :END:
The second important point about the Redux architecture is that the state is
not just a tree, but it is in fact an immutable tree.
*** The state is not just a tree, but it is in fact an immutable tree.
Looking at the trees in the previous section, it might at first seem like a
reasonable idea to have code that changes the state of the application by just
making updates in the tree: Replacing things in maps, removing things from
arrays, etc. However, this is not how things are done in Redux.
*** the next state is another state tree that reflects the current changes
A Redux application's state tree is an immutable data structure. That means
that once you have a state tree, it will never change as long as it exists. It
will keep holding the same state forever. How you then go to the next state is
by producing another state tree that reflects the changes you wanted to make.
*** Two successive states of the application are stored in two separate and independent trees. 
This means any two successive states of the application are stored in two
separate and independent trees. How you get from one to the next is by applying
a function that takes the current state and returns a new state.
*** How you get from one to the next is by applying a function that takes the current state and returns a new state.
*** Immutability Helpful for debuging
**** Can hold on to the history of your application
**** You can then do things like undo/redo for "free"
**** serialize the history
just setthe current application state to the previous or next tree in the history. 
You can also serialize the history and save it for later, or send it to some
storage so that you can replay it later, which can be hugely helpful when
debugging.
*** Data in, data out , pure function
However, I'd say that even beyond these extra features, the most important
thing about immutable data is how it simplifies your code. You get to program
with pure functions: 
**** pure functions: 
Functions that take data and return data and do nothing
else. These are functions that you can trust to behave predictably. You can
call them as many times as you like and their behavior won't change. Give them
the same arguments, and they'll return the same results. They're not going to
change the state of the world. Testing becomes trivial, as you don't need to
set up stubs or other fakes to "prepare the universe" before you call
something. It's just data in, data out.
*** Immutable data structures are the material we'll build our application's state
   CLOCK: [2015-11-24 মঙ্গল 12:35]--[2015-11-24 মঙ্গল 13:35] =>  1:00
Immutable data structures are the material we'll build our application's state
from, so let's spend some time getting comfortable with it by writing some unit
tests that illustrate how it all works.
*** Unit Testing Immutable Counter 
If you're already comfortable with immutable data and the Immutable library,
feel free to skip to the next section. 
**** To get acquainted with the idea of immutability
it may be helpful to first talk about the simplest possible data structure: What if you had a "counter"
application whose state was nothing but a single number? The state would go
from 0 to 1 to 2 to 3, etc.
**** We are already used to thinking of numbers as immutable data. 
     When the counter increments, we don't mutate a number. It would in fact be 
     impossible as there are no "setters" on numbers. You can't say 42.setValue(43).
**** What happens instead is we get another number
     Which is the result of adding 1 to the previous number. 
     That we can do with a pure function. Its argument is the current state and 
     its return value will be used as the next state. When it is called, 
     it does not change the current state. Here is such a function and a
     unit test for it:

#+BEGIN_SRC js :tangle test/immutable_spec.js
  import {expect} from 'chai'
  describe('a number', () => {
    function increment(currentState) {
      return currentState + 1;
    }
    it('is immutable', () => {
      let state = 42;
      let nextState = increment(state);
      expect(nextState).to.equal(43);
      expect(state).to.equal(42);
    });
  });
#+END_SRC

#+BEGIN_SRC sh :results verbatim drawer
npm run test
#+END_SRC

#+RESULTS:
:RESULTS:

> voting-server@1.0.0 test /usr/local/src/jstutorials/voting-server
> mocha --compilers js:babel-core/register --require ./test/test_helper.js --recursive



  immutability
    a number
      ✓ is immutable


  1 passing (55ms)

:END:

**** The fact that state doesn't change when increment is called should be obvious.
     How could it? Numbers are immutable!
**** You may have noticed that this test really has nothing to do with our
     application - we don't even have any application code yet! 
**** The test is just a learning tool for us. 
     I often find it useful to explore a new API or technique by writing unit tests 
     that exercise the relevant ideas, which is what we're doing here. Kent Beck calls 
     these kinds of tests "Learning Tests" in his original TDD book. 
     
     What we're going to do next is extend this same idea of immutability to all
     kinds of data structures, not just numbers.

**** Immutable's Lists 
     we can, for example, have an application whose state is
     a list of movies. An operation that adds a movie produces a new list that is
     the old list and the new movie combined. Crucially, the old state remains
     unchanged after the operation:
Head:     dad130b master immutable list tested
#+BEGIN_SRC js :tangle test/immutable_spec.js
imporot {expect} from 'chai';
import {List} from 'immutable';

describe('immutability', () => {
  describe('a number', () => {
    function increment(currentState) {
      return currentState + 1;
    }
    it('is immutable', () => {
      let state = 42;
      let nextState = increment(state);
      expect(nextState).to.equal(43);
      expect(state).to.equal(42);
    });
  });

  describe('A List', () => {
    function addMovie(currentState, movie){
      return currentState.push(movie);
    }

    it('is immutable', () => {
      let state = List.of('Trainspotting', '28 Days Later');
      let nextState = addMovie(state, 'Sunshine');

      expect(nextState).to.equal(List.of(
	'Trainspotting',
	'28 Days Later',
	'Sunshine'
      ));
      expect(state).to.equal(List.of(
	'Trainspotting',
	'28 Days Later'
      ));

    });
  });
});
#+END_SRC

#+BEGIN_SRC sh
npm run test
#+END_SRC

#+RESULTS:
 > voting-server@1.0.0  test  /usr/local/src/jstutorials/voting-server
 > mocha --compilers  js:babel-core/register --require ./test/test_helper.js --recursive 

|--------------+---------+--------+-----------|
| immutability |         |        |           |
| a            | number  |        |           |
|              | ✓       | is     | immutable |
| A            | List    |        |           |
|              | ✓       | is     | immutable |
|              |         |        |           |
|              |         |        |           |
| 2            | passing | (28ms) |           |
|              |         |        |           |

The old state would not have remained unchanged if we'd pushed into a regular
array! Since we're using an Immutable List instead, we have the same semantics
as we had with the number example.

The idea extends to full state trees as well. A state tree is just a nested
data structure of Lists, Maps, and possibly other kinds of collections.
Applying an operation to it involves producing a new state tree, leaving the
previous one untouched. If the state tree is a Map with a key 'movies' that
contains a List of movies, 
**** adding a movie means we need to create a new Map where the movies key points to a new List
#+BEGIN_SRC js :tangle test/immutable_spec.js
imporot {expect} from 'chai';
import {List, Map} from 'immutable';

describe('immutability', () => {
  describe('a number', () => {
    function increment(currentState) {
      return currentState + 1;
    }
    it('is immutable', () => {
      let state = 42;
      let nextState = increment(state);
      expect(nextState).to.equal(43);
      expect(state).to.equal(42);
    });
  });

  describe('A List', () => {
    function addMovie(currentState, movie){
      return currentState.push(movie);
    }

    it('is immutable', () => {
      let state = List.of('Trainspotting', '28 Days Later');
      let nextState = addMovie(state, 'Sunshine');

      expect(nextState).to.equal(List.of(
	'Trainspotting',
	'28 Days Later',
	'Sunshine'
      ));
      expect(state).to.equal(List.of(
	'Trainspotting',
	'28 Days Later'
      ));

    });
  });

  describe('a tree' , () => {
    function addMovie(currentState, movie ) {
      return currentState.set(
	'movies',
	currentState.get('movies').push(movie)
      );
    }

    it('is immatable', () => {
      let state = Map({
	movies: List.of('Trainspotting', '28 Days Later')
      });
      let nextState = addMovie(state, 'Sunshine');

      expect(nextState).to.equal(Map({
	movies: List.of(
	  'Trainspotting',
	  '28 Days Later',
	  'Sunshine'
	)
      }));
    });
  });
});
#+END_SRC

#+BEGIN_SRC sh
npm run test
#+END_SRC
Head:     19afc7b master new Map where the movies key points to a new List

#+RESULTS:
 > voting-server@1.0.0 test /usr/local/src/jstutorials/voting-server
 > mocha --compilers  js:babel-core/register  --require ./test/test_helper.js --recursive 

| immutability |         |        |           |  
| a	       | number	 |	  |	      |	 
|	       | ✓	 | is	  | immutable |	 
| A	       | List	 |	  |	      |	 
|	       | ✓	 | is	  | immutable |	 
| a	       | tree	 |	  |	      |	 
|	       | ✓	 | is	  | immatable |	 
|	       |	 |	  |	      |	 
|	       |	 |	  |	      |	 
| 3	       | passing | (30ms) |	      |	 
|	       |	 |	  |	      |	 

This is exactly the same behavior as before, just extended to show that it
works with nested data structures too. The same idea holds to all shapes and
sizes of data.

For operations on nested data structures such as this one, Immutable provides
several helper functions that make it easier to "reach into" the nested data to
produce an updated value. We can use one called update in this case to make the
code more concise:
#+BEGIN_SRC patch :tangle test/immutable_spec.js
-    function addMovie(currentState, movie ) {
-      return currentState.set(
-	'movies',
-	currentState.get('movies').push(movie)
-      );
+    function addMovie(currentState, movie) {
+      return currentState.update('movies', movies => movies.push(movie));
#+END_SRC

#+BEGIN_SRC sh
npm run test
#+END_SRC
Head:     b23ffbc master helper functions that make it easier to reach into
#+RESULTS:
| >  voting-server@1.0.0  test  /usr/local/src/jstutorials/voting-server     
| >  mocha  --compilers  js:babel-core/register  --require  ./test/test_helper.js  --recursive  

| immutability |         |        |           |
| a            | number  |        |           |
|              | ✓       | is     | immutable |
| A            | List    |        |           |
|              | ✓       | is     | immutable |
| a            | tree    |        |           |
|              | ✓       | is     | immatable |
|              |         |        |           |
|              |         |        |           |
| 3            | passing | (33ms) |           |
|              |         |        |           |
**** Reasons for using IMMUTABLE library
***** Immutable's data structures are designed from the ground up to be used
      immutably and thus provide an API that makes immutable operations convenient. 
***** I'm partial to Rich Hickey's view that there is no such as thing as
      immutability by convention. If you use data structures that allow mutations,
      sooner or later you or someone else is bound to make a mistake and mutate
      them. This is especially true when you're just getting started. Things like
      Object.freeze() may help with this. 
***** Immutable's data structures are persistent, meaning that they are internally
      structured so that producing new versions is efficient both in terms of time
      and memory, even for large state trees. Using plain objects and arrays may
      result in excessive amounts of copying, which hurts performance. 

** Writing The Application Logic With Pure Functions 
#+BEGIN: clocktable :maxlevel 4 :scope subtree
#+CAPTION: Clock summary at [2015-11-24 মঙ্গল 21:36]
| Headline                                              | Time   |      |      |      |
|-------------------------------------------------------+--------+------+------+------|
| *Total time*                                          | *5:09* |      |      |      |
|-------------------------------------------------------+--------+------+------+------|
| \emsp Writing The Application Logic With...           |        | 5:09 |      |      |
| \emsp\emsp Loading Entries                            |        |      | 1:03 |      |
| \emsp\emsp\emsp Test Case for Entries and Source Code |        |      |      | 1:03 |
| \emsp\emsp Starting The Vote Second state             |        |      | 0:30 |      |
| \emsp\emsp Voting                                     |        |      | 1:12 |      |
| \emsp\emsp Moving to The Next Pair                    |        |      | 0:50 |      |
| \emsp\emsp Ending The Vote                            |        |      | 0:33 |      |
#+END:

   CLOCK: [2015-11-24 মঙ্গল 10:02]--[2015-11-24 মঙ্গল 11:03] =>  1:01
   :PROPERTIES:
   :Effort:   0:54
   :ORDERED:  t
   :END:
Armed with an understanding of immutable state trees and the functions that
operate on them, we can turn our attention to the logic of our voting
application itself. The core of the app will be formed from the pieces that we
have been discussing: A tree structure and a set of functions that produce new
versions of that tree structure.

*** Loading Entries
**** Test Case for Entries and Source Code
     the application allows "loading in" a collection of entries that will be voted on. 
     We could have a function called setEntries that takes a previous state and 
     a collection of entries and produces a state where the entries are included. 
#+BEGIN_SRC js :tangle test/core_spec.js
import {List, Map} from 'immutable';
import {expect} from 'chai';
import {setEntries} from '../src/core';

describe('application logic', () => {
  describe('setEntries', () => {
    it('adds the entries to the state', ()=> {
      const state = Map();
      const entries = List.of('Trainspotting', '28 Days Later');
      const nextState = setEntries(state, entries);
      expect(nextState).to.equal(Map({
        entries: List.of('Trainspotting', '28 Days Later')
      }));
    });
  });
});

#+END_SRC

#+BEGIN_SRC js :tangle src/core.js
export function setEntries(state,entries){
  return state.set('entries', entries);
}
#+END_SRC

#+BEGIN_SRC sh :results verbatim 
npm run test 
#+END_SRC

#+RESULTS:
#+begin_example

> voting-server@1.0.0 test /usr/local/src/jstutorials/voting-server
> mocha --compilers js:babel-core/register --require ./test/test_helper.js --recursive



  application logic
    setEntries
      ✓ adds the entries to the state

  immutability
    a number
      ✓ is immutable
    A List
      ✓ is immutable
    a tree
      ✓ is immatable


  4 passing (105ms)

#+end_example
***** Array to Immutable List
      CLOCK: [2015-11-24 মঙ্গল 15:17]--[2015-11-24 মঙ্গল 16:20] =>  1:03

#+BEGIN_SRC sh :results verbatim
npm run test
#+END_SRC 

#+RESULTS:
#+begin_example

> voting-server@1.0.0 test /usr/local/src/jstutorials/voting-server
> mocha --compilers js:babel-core/register --require ./test/test_helper.js --recursive



  application logic
    setEntries
      ✓ adds the entries to the state

  immutability
    a number
      ✓ is immutable
    A List
      ✓ is immutable
    a tree
      ✓ is immatable


  4 passing (36ms)

#+end_example

#+BEGIN_SRC patch :tangle src/core.js
@@ -1,4 +1,4 @@
-
+import {List} from 'immutable';
 export function setEntries(state,entries){
-  return state.set('entries', entries);
+  return state.set('entries', List(entries));
 }
#+END_SRC

#+BEGIN_SRC test/core_spec.js
@@ -6,9 +6,9 @@ import {setEntries} from '../src/core';
 describe('application logic', () => {
   describe('setEntries', () => {
     it('adds the entries to the state', ()=> {
       const state = Map();
-      const entries = List.of('Trainspotting', '28 Days Later');
+      const entries = ['Trainspotting', '28 Days Later'];
       const nextState = setEntries(state, entries);
       expect(nextState).to.equal(Map({
         entries: List.of('Trainspotting', '28 Days Later')
       }));
#+END_SRC

*** Starting The Vote Second state
    CLOCK: [2015-11-24 মঙ্গল 16:12]--[2015-11-24 মঙ্গল 16:42] =>  0:30
    
    We can begin the voting by calling a function called next on a state that
already has entries set. That means, going from the first to the second of the
state trees we designed.

The function takes no additional arguments. It should create a vote Map on the
state, where the two first entries are included under the key pair. The entries
under vote should no longer be in the entries List:
#+BEGIN_SRC sh :results verbatim
npm run test
#+END_SRC

#+RESULTS:
#+begin_example

> voting-server@1.0.0 test /usr/local/src/jstutorials/voting-server
> mocha --compilers js:babel-core/register --require ./test/test_helper.js --recursive



  application logic
    setEntries
      ✓ adds the entries to the state
    next
      ✓ takes the next two entries under vote

  immutability
    a number
      ✓ is immutable
    A List
      ✓ is immutable
    a tree
      ✓ is immatable


  5 passing (28ms)

#+end_example
**** Head:     9e91d63 master prepare 2 canditate for voting.
#+BEGIN_SRC 
modified   src/core.js
@@ -1,4 +1,12 @@
-import {List} from 'immutable';
+import {List, Map} from 'immutable';
 export function setEntries(state,entries){
   return state.set('entries', List(entries));
 }
+
+export function next(state){
+  const entries = state.get('entries');
+  return state.merge({
+    vote: Map({pair: entries.take(2)}),
+    entries: entries.skip(2)
+  });
+}
modified   test/core_spec.js
@@ -1,7 +1,7 @@
 
 import {List, Map} from 'immutable';
 import {expect} from 'chai';
-import {setEntries} from '../src/core';
+import {setEntries, next} from '../src/core';
 
 describe('application logic', () => {
   describe('setEntries', () => {
@@ -14,4 +14,18 @@ describe('application logic', () => {
       }));
     });
   });
+  describe('next',() => {
+    it('takes the next two entries under vote', () => {
+      const state = Map({
+	entries: List.of('Trainspotting', '28 Days Later', 'Sunshine')
+      });
+      const nextState = next(state);
+      expect(nextState).to.equal(Map({
+	vote: Map({
+	  pair: List.of('Trainspotting', '28 Days Later')
+	}),
+	entries: List.of('Sunshine')
+      }));
+    });
+  });
 });
#+END_SRC
*** Voting
    CLOCK: [2015-11-24 মঙ্গল 18:15]--[2015-11-24 মঙ্গল 19:27] =>  1:12
    :PROPERTIES:
    :Effort:   1:00
    :END:

    When a vote is ongoing, it should be possible for people to vote on entries.
    When a new vote is cast for an entry, a "tally" for it should appear in the
    vote. If there already is a tally for the entry, it should be incremented:
    
    tag: 40d673bc12d521250ff4418e09105ac270f92c4d
    Parent:     d17fe11 diff code insertion
    
    #+BEGIN_SRC 
modified   src/core.js
@@ -10,3 +10,11 @@ export function next(state){
     entries: entries.skip(2)
   });
 }
+
+export function vote(state, entry){
+  return state.updateIn(
+    ['vote', 'tally', entry ],
+    0,
+    tally => tally + 1
+  );
+}
modified   test/core_spec.js
@@ -1,7 +1,7 @@
 
 import {List, Map} from 'immutable';
 import {expect} from 'chai';
-import {setEntries, next} from '../src/core';
+import {setEntries, next, vote} from '../src/core';
 
 describe('application logic', () => {
   describe('setEntries', () => {
@@ -28,4 +28,47 @@ describe('application logic', () => {
       }));
     });
   });
+  describe('vote', () => {
+    it('creates a tally for the voted entry', () => {
+      const state = Map({
+	vote: Map({
+	  pair: List.of('Trainspotting', '28 Days Later')
+	}),
+	entries: List()
+      });
+      const nextState = vote(state, 'Trainspotting' );
+      expect(nextState).to.equal(Map({
+	vote: Map({
+	  pair: List.of('Trainspotting', '28 Days Later'),
+	  tally: Map({
+	    'Trainspotting': 1
+	  })
+	}),
+	entries: List()
+      }));
+    });
+    it('adds to existing tally for the voted entry', () => {
+      const state = Map({
+	vote: Map({
+	  pair: List.of('Trainspotting', '28 Days Later'),
+	  tally: Map({
+	    'Trainspotting': 3,
+	    '28 Days Later': 2
+	  }),
+	}),
+	entries: List()
+      });
+      const nextState = vote(state, 'Trainspotting');
+      expect(nextState).to.equal(Map({
+	vote: Map({
+	  pair: List.of('Trainspotting', '28 Days Later'),
+	  tally: Map({
+	    'Trainspotting': 4,
+	    '28 Days Later': 2
+	  }),
+	}),
+	entries: List()
+      }));
+    });
+  });
 });
#+END_SRC

    #+BEGIN_SRC sh :results verbatim
    npm run test 
    #+END_SRC

    #+RESULTS:
    #+begin_example

 > voting-server@1.0.0 test /usr/local/src/jstutorials/voting-server
 > mocha --compilers js:babel-core/register --require ./test/test_helper.js --recursive



   application logic
     setEntries
       ✓ adds the entries to the state
     next
       ✓ takes the next two entries under vote
     vote
       ✓ creates a tally for the voted entry
       ✓ adds to existing tally for the voted entry

   immutability
     a number
       ✓ is immutable
     A List
       ✓ is immutable
     a tree
       ✓ is immatable


   7 passing (29ms)

#+end_example
    Using updateIn makes this pleasingly succinct. What the code expresses is
    "reach into the nested data structure path ['vote', 'tally', 'Trainspotting'],
    and apply this function there. If there are keys missing along the path, create
    new Maps in their place. If the value at the end is missing, initialize it with
    0".

    It packs a lot of punch, but this is exactly the kind of code that makes
    working with immutable data structures pleasant, so it's worth spending a bit
    of time getting comfortable with it.
    
    You could build all these nested Maps and Lists more concisely using the fromJS
    function from Immutable. 

*** Moving to The Next Pair 
    CLOCK: [2015-11-24 মঙ্গল 19:32]--[2015-11-24 মঙ্গল 20:22] =>  0:50
    :PROPERTIES:
    :Effort:   0:39
    :END:
    Once the vote for a given pair is over, we should proceed to the next one. The
    winning entry from the current vote should be kept, and added back to the end
    of the entries, so that it will later be paired with something else. The losing
    entry is thrown away. If there is a tie, both entries are kept.
    Head:     c5b0f2d master send winner[s] back to entries
    tag: c5b0f2dff360b81b73e5d422b211f0d8bae60c13
    #+BEGIN_SRC 
 @@ -3,8 +3,19 @@ export function setEntries(state,entries){
   return state.set('entries', List(entries));
 }
 
+function getWinners(vote) {
+  if (!vote) return [];
+  const [a,b] = vote.get('pair');
+  const aVotes = vote.getIn(['tally', a ] , 0);
+  const bVotes = vote.getIn(['tally', b ] , 0);
+  if ( aVotes > bVotes )    return [a];
+  if ( aVotes < bVotes )    return [b];
+  return [a, b];
+}
+
 export function next(state){
-  const entries = state.get('entries');
+  const entries = state.get('entries')
+                       .concat(getWinners(state.get('vote')));
   return state.merge({
     vote: Map({pair: entries.take(2)}),
     entries: entries.skip(2)
modified   test/core_spec.js
@@ -27,7 +27,47 @@ describe('application logic', () => {
 	entries: List.of('Sunshine')
       }));
     });
+    it('puts winner of current vote back to entries', () => {
+      const state = Map({
+	vote: Map({
+	  pair: List.of('Trainspotting', '28 Days Later'),
+          tally: Map({
+            'Trainspotting': 4,
+            '28 Days Later': 2
+          })
+	}),
+	entries: List.of('Sunshine', 'Millions', '127 Hours')
+      });
+      const nextState = next(state);
+      expect(nextState).to.equal(Map({
+	vote: Map({
+          pair: List.of('Sunshine', 'Millions')
+	}),
+	entries: List.of('127 Hours', 'Trainspotting')
+      }));
+    });
+
+    it('puts both from tied vote back to entries', () => {
+      const state = Map({
+	vote: Map({
+          pair: List.of('Trainspotting', '28 Days Later'),
+          tally: Map({
+            'Trainspotting': 3,
+            '28 Days Later': 3
+          })
+	}),
+	entries: List.of('Sunshine', 'Millions', '127 Hours')
+      });
+      const nextState = next(state);
+      expect(nextState).to.equal(Map({
+	vote: Map({
+          pair: List.of('Sunshine', 'Millions')
+	}),
+	entries: List.of('127 Hours', 'Trainspotting', '28 Days Later')
+      }));
+    });
   });
+  
   describe('vote', () => {
     it('creates a tally for the voted entry', () => {
       const state = Map({

    #+END_SRC
    
    #+BEGIN_SRC sh :results verbatim
    npm run test
    #+END_SRC

    #+RESULTS:
    #+begin_example

    > voting-server@1.0.0 test /usr/local/src/jstutorials/voting-server
    > mocha --compilers js:babel-core/register --require ./test/test_helper.js --recursive



      application logic
	setEntries
          ✓ adds the entries to the state
	next
          ✓ takes the next two entries under vote
          ✓ puts winner of current vote back to entries
          ✓ puts both from tied vote back to entries
	vote
          ✓ creates a tally for the voted entry
          ✓ adds to existing tally for the voted entry

      immutability
	a number
          ✓ is immutable
	A List
          ✓ is immutable
	a tree
          ✓ is immatable


      9 passing (35ms)

#+end_example

*** Ending The Vote 
    CLOCK: [2015-11-24 মঙ্গল 20:15]--[2015-11-24 মঙ্গল 20:48] =>  0:33

    At some point there's just going to be one entry left when a vote ends. At that
    point we have a winning entry. What we should do is, instead of trying to form
    a next vote, just set the winner in the state explicitly. The vote is over.

    In the implementation of next we should have a special case for the situation
    where the entries has a size of 1 after we've processed the current vote:
Head:     c37c165 master get winner ending...
tag: c37c165998a38553e195d7b644491c23f683b731
#+BEGIN_SRC 
modified   src/core.js
@@ -15,7 +15,11 @@ function getWinners(vote) {
 
 export function next(state){
   const entries = state.get('entries')
-                       .concat(getWinners(state.get('vote')));
+    .concat(getWinners(state.get('vote')));
+  if (entries.size === 1 )
+    return state.remove('vote')
+                .remove('entries')
+                .set('winner', entries.first()); 
   return state.merge({
     vote: Map({pair: entries.take(2)}),
     entries: entries.skip(2)
modified   test/core_spec.js
@@ -66,6 +66,22 @@ describe('application logic', () => {
 	entries: List.of('127 Hours', 'Trainspotting', '28 Days Later')
       }));
     });
+    it('marks winner when just one entry left', () => {
+      const state = Map({
+	vote: Map({
+          pair: List.of('Trainspotting', '28 Days Later'),
+          tally: Map({
+            'Trainspotting': 4,
+            '28 Days Later': 2
+          })
+	}),
+	entries: List()
+      });
+      const nextState = next(state);
+      expect(nextState).to.equal(Map({
+	winner: 'Trainspotting'
+      }));
+    });
   });
   
   describe('vote', () => {
#+END_SRC

#+BEGIN_SRC sh :results verbatim
npm run test
#+END_SRC

#+RESULTS:
#+begin_example

> voting-server@1.0.0 test /usr/local/src/jstutorials/voting-server
> mocha --compilers js:babel-core/register --require ./test/test_helper.js --recursive



  application logic
    setEntries
      ✓ adds the entries to the state
    next
      ✓ takes the next two entries under vote
      ✓ puts winner of current vote back to entries
      ✓ puts both from tied vote back to entries
      ✓ marks winner when just one entry left
    vote
      ✓ creates a tally for the voted entry
      ✓ adds to existing tally for the voted entry

  immutability
    a number
      ✓ is immutable
    A List
      ✓ is immutable
    a tree
      ✓ is immatable


  10 passing (58ms)

#+end_example

We could have just returned Map({winner: entries.first()}) here. But instead we
still take the old state as the starting point and explicitly remove 'vote' and
'entries' keys from it. The reason for this is future-proofing: At some point
we might have some unrelated data in the state, and it should pass through this
function unchanged. It is generally a good idea in these state transformation
functions to always morph the old state into the new one instead of building
the new state completely from scratch.

Here we have an acceptable version of the core logic of our app, expressed as a
few functions. We also have unit tests for them, and writing those tests has
been relatively easy: No setup, no mocks, no stubs. That's the beauty of pure
functions. We can just call them and inspect the return values.

Note that we haven't even installed Redux yet. We've been able to focus totally
on the logic of the app itself, without bringing the "framework" in. There's
something very pleasing about that.

** Introducing Actions and Reducers
   CLOCK: [2015-11-24 মঙ্গল 20:56]--[2015-11-24 মঙ্গল 21:27] =>  0:31
   :PROPERTIES:
   :Effort:   0:30
   :END:
 
   We have the core functions of our app, but in Redux you don't actually call
   those functions directly. There is a layer of indirection between the functions
   and the outside world: Actions.

   An action is a simple data structure that describes a change that should occur
   in your app state. It's basically a description of a function call packaged
   into a little object. By convention, every action has a type attribute that
   describes which operation the action is for. Each action may also carry
   additional attributes. Here are a few example actions that match the core
   functions we have just written:

   {type: 'SET_ENTRIES', entries: ['Trainspotting', '28 Days Later']}
   
   {type: 'NEXT'}

   {type: 'VOTE', entry: 'Trainspotting'}

   If actions are expressed like this, we also need a way to turn them into the
   actual core function calls. For example, given the VOTE action, the following
   call should be made:

   // This action
   let voteAction = {type: 'VOTE', entry: 'Trainspotting'}
   // should cause this to happen
   return vote(state, voteAction.entry);

   What we're going to write is a generic function that takes any kind of action -
   along with the current state - and invokes the core function that matches the
   action. This function is called a reducer:
#+BEGIN_SRC js 
export default function reducer(state, action) {
// Figure out which function to call and call it
}
#+END_SRC

We should test that the reducer can indeed handle each of our three actions:

#+BEGIN_SRC js 
import {Map, fromJS} from 'immutable'
import {expect} from 'chai';
import reducer from '../src/reducer';

  it('handles SET_ENTRIES', () => {
    const initialState = Map();
    const action = { type: 'SET_ENTRIES', entries: ['Trainspotting'] };
    const nextState = reducer(initialState, action );
    expect(nextState).to.equal(fromJS({
      entries: ['Trainspotting']
    }));
  });
  
  it('handles NEXT', () => {
    const initialState = fromJS({
      entries: ['Trainspotting', '28 Days Later']
    });
    const action = {type: 'NEXT'};
    const nextState = reducer(initialState, action);

    expect(nextState).to.equal(fromJS({
      vote: {
        pair: ['Trainspotting', '28 Days Later'],
        tally: {Transformation: 1}
      },
      entries: []
    }));
  });
    
  it('handles VOTE', () => { 
    const initialState = fromJS({
      vote: {
        pair: ['Trainspotting', '28 Days Later']
      },
      entries: []
    });
    const action = {type: 'VOTE', entry: 'Trainspotting'};
    const nextState = reducer(initialState, action);

    expect(nextState).to.equal(fromJS({
      vote: {
        pair: ['Trainspotting', '28 Days Later'],
        tally: {Transformation: 1}
      },
      entries: []
    }));
  });
});
#+END_SRC   
Our reducer should delegate to one of the core functions based on the type of
the action. It also knows how to unpack the additional arguments of each
function from the action object:

#+BEGIN_SRC 
import {setEntries, next, vote} from './core';

export default function reducer(state, action) {
  switch (action.type) {
    case 'SET_ENTRIES':
      return setEntries(state, action.entries);
    case 'NEXT':
      return next(state);
    case 'VOTE':
      return vote(state, action.entry)
  }
  return state;
}
#+END_SRC

#+BEGIN_SRC sh
npm run test
#+END_SRC

#+RESULTS:

 > voting-server@1.0.0 test /usr/local/src/jstutorials/voting-server
 > mocha --compilers  js:babel-core/register  --require  ./test/test_helper.js  --recursive 

| application  | logic   |         |             |          |         |         |       |       |         |
| setEntries   |         |         |             |          |         |         |       |       |         |
|              | ✓       | adds    | the         | entries  | to      | the     | state |       |         |
| next         |         |         |             |          |         |         |       |       |         |
|              | ✓       | takes   | the         | next     | two     | entries | under | vote  |         |
|              | ✓       | puts    | winner      | of       | current | vote    | back  | to    | entries |
|              | ✓       | puts    | both        | from     | tied    | vote    | back  | to    | entries |
|              | ✓       | marks   | winner      | when     | just    | one     | entry | left  |         |
| vote         |         |         |             |          |         |         |       |       |         |
|              | ✓       | creates | a           | tally    | for     | the     | voted | entry |         |
|              | ✓       | adds    | to          | existing | tally   | for     | the   | voted | entry   |
|              |         |         |             |          |         |         |       |       |         |
| immutability |         |         |             |          |         |         |       |       |         |
| a            | number  |         |             |          |         |         |       |       |         |
|              | ✓       | is      | immutable   |          |         |         |       |       |         |
| A            | List    |         |             |          |         |         |       |       |         |
|              | ✓       | is      | immutable   |          |         |         |       |       |         |
| a            | tree    |         |             |          |         |         |       |       |         |
|              | ✓       | is      | immatable   |          |         |         |       |       |         |
|              |         |         |             |          |         |         |       |       |         |
| Reducer      |         |         |             |          |         |         |       |       |         |
|              | ✓       | handles | SET_ENTRIES |          |         |         |       |       |         |
|              | ✓       | handles | NEXT        |          |         |         |       |       |         |
|              | ✓       | handles | VOTE        |          |         |         |       |       |         |
|              |         |         |             |          |         |         |       |       |         |
|              |         |         |             |          |         |         |       |       |         |
| 13           | passing | (98ms)  |             |          |         |         |       |       |         |
|              |         |         |             |          |         |         |       |       |         |

test/reducer_spec.js
describe('reducer', () => {

  // ...

  it('has an initial state', () => {
    const action = {type: 'SET_ENTRIES', entries: ['Trainspotting']};
    const nextState = reducer(undefined, action);
    expect(nextState).to.equal(fromJS({
      entries: ['Trainspotting']
    }));
  });

});

Since our application's logic is in core.js, it makes sense to introduce the
initial state there:

src/core.js
export const INITIAL_STATE = Map();

In the reducer we'll import it and use it as the default value of the state
argument:

src/reducer.js
import {setEntries, next, vote, INITIAL_STATE} from './core';

export default function reducer(state = INITIAL_STATE, action) {
  switch (action.type) {
  case 'SET_ENTRIES':
    return setEntries(state, action.entries);
  case 'NEXT':
    return next(state);
  case 'VOTE':
    return vote(state, action.entry)
  }
  return state;
}

#+BEGIN_SRC sh
npm run test
#+END_SRC

#+RESULTS:
|              |                     |             |                                          |           |                       |             |       |       |         |
| >            | voting-server@1.0.0 | test        | /usr/local/src/jstutorials/voting-server |           |                       |             |       |       |         |
| >            | mocha               | --compilers | js:babel-core/register                   | --require | ./test/test_helper.js | --recursive |       |       |         |
|              |                     |             |                                          |           |                       |             |       |       |         |
|              |                     |             |                                          |           |                       |             |       |       |         |
|              |                     |             |                                          |           |                       |             |       |       |         |
| application  | logic               |             |                                          |           |                       |             |       |       |         |
| setEntries   |                     |             |                                          |           |                       |             |       |       |         |
|              | ✓                   | adds        | the                                      | entries   | to                    | the         | state |       |         |
| next         |                     |             |                                          |           |                       |             |       |       |         |
|              | ✓                   | takes       | the                                      | next      | two                   | entries     | under | vote  |         |
|              | ✓                   | puts        | winner                                   | of        | current               | vote        | back  | to    | entries |
|              | ✓                   | puts        | both                                     | from      | tied                  | vote        | back  | to    | entries |
|              | ✓                   | marks       | winner                                   | when      | just                  | one         | entry | left  |         |
| vote         |                     |             |                                          |           |                       |             |       |       |         |
|              | ✓                   | creates     | a                                        | tally     | for                   | the         | voted | entry |         |
|              | ✓                   | adds        | to                                       | existing  | tally                 | for         | the   | voted | entry   |
|              |                     |             |                                          |           |                       |             |       |       |         |
| immutability |                     |             |                                          |           |                       |             |       |       |         |
| a            | number              |             |                                          |           |                       |             |       |       |         |
|              | ✓                   | is          | immutable                                |           |                       |             |       |       |         |
| A            | List                |             |                                          |           |                       |             |       |       |         |
|              | ✓                   | is          | immutable                                |           |                       |             |       |       |         |
| a            | tree                |             |                                          |           |                       |             |       |       |         |
|              | ✓                   | is          | immatable                                |           |                       |             |       |       |         |
|              |                     |             |                                          |           |                       |             |       |       |         |
| Reducer      |                     |             |                                          |           |                       |             |       |       |         |
|              | ✓                   | handles     | SET_ENTRIES                              |           |                       |             |       |       |         |
|              | ✓                   | handles     | NEXT                                     |           |                       |             |       |       |         |
|              | ✓                   | handles     | VOTE                                     |           |                       |             |       |       |         |
|              | ✓                   | has         | an                                       | initial   | state                 |             |       |       |         |
|              |                     |             |                                          |           |                       |             |       |       |         |
|              |                     |             |                                          |           |                       |             |       |       |         |
| 14           | passing             | (40ms)      |                                          |           |                       |             |       |       |         |
|              |                     |             |                                          |           |                       |             |       |       |         |
This ability to batch and/or replay a collection of actions is a major benefit
of the action/reducer model of state transitions, when compared to calling the
core functions directly. For example, given that actions are just objects that
you can also serialize to JSON, you could easily send them over to a Web Worker
and run your reducer logic there. Or you can even send them over the network,
as we're going to do later!

Note that we are using plain objects as actions instead of Immutable data
structures. This is something Redux actually requires us to do. 

** A Taste of Reducer Composition
   CLOCK: [2015-11-26 বৃহঃ 00:15]--[2015-11-26 বৃহঃ 00:25] =>  0:10
 
Our core functionality is currently defined so that each function takes the
whole state of the application and returns the whole, next state of the
application.

It is easy to see how keeping to this pattern may not be a good idea in large
applications. If each and every operation in the application needs to be aware
of the structure of the whole state, things can easily get brittle. If you
wanted to change the shape of the state, it would require a whole lot of
changes.

It is a much better idea to, whenever you can, make operations work on the
smallest piece (or subtree) of the state possible. What we're talking about is
modularization: Have the functionality that deals with a given piece of data
deal with only that part of the data, as if the rest didn't exist.

Our application is so tiny that we don't have a problem of this kind yet, but
we do already have one opportunity to improve on this: There is no reason for
the vote function to receive the whole app state, since it only works on the
'vote' part of it. That's the only thing it should know about. We can modify
the existing unit tests for vote to reflect this idea:

test/core_spec.js
describe('vote', () => {

  it('creates a tally for the voted entry', () => {
    const state = Map({
      pair: List.of('Trainspotting', '28 Days Later')
    });
    const nextState = vote(state, 'Trainspotting')
    expect(nextState).to.equal(Map({
      pair: List.of('Trainspotting', '28 Days Later'),
      tally: Map({
        'Trainspotting': 1
      })
    }));
  });

  it('adds to existing tally for the voted entry', () => {
    const state = Map({
      pair: List.of('Trainspotting', '28 Days Later'),
      tally: Map({
        'Trainspotting': 3,
        '28 Days Later': 2
      })
    });
    const nextState = vote(state, 'Trainspotting');
    expect(nextState).to.equal(Map({
      pair: List.of('Trainspotting', '28 Days Later'),
      tally: Map({
        'Trainspotting': 4,
        '28 Days Later': 2
      })
    }));
  });

});

As we see, this also simplifies the test code, which is usually a good sign!

The vote implementation should now just take the vote part of the state, and
update its tally:

src/core.js
export function vote(voteState, entry) {
  return voteState.updateIn(
    ['tally', entry],
    0,
    tally => tally + 1
  );
}

Now it becomes the job of our reducer to pick apart the state so that it gives
only the relevant part to the vote function:

src/reducer.js
export default function reducer(state = INITIAL_STATE, action) {
  switch (action.type) {
  case 'SET_ENTRIES':
    return setEntries(state, action.entries);
  case 'NEXT':
    return next(state);
  case 'VOTE':
    return state.update('vote',
                        voteState => vote(voteState, action.entry));
  }
  return state;
}

This is a small example of the kind of pattern that becomes much more important
the larger an application gets: The main reducer function only hands parts of
the state to lower-level reducer functions. We separate the job of finding the
right location in the state tree from applying the update to that location.

The Redux documentation for reducers goes into these patterns of reducer
composition in a lot more detail, and also describes some helper functions that
makes reducer composition easier in many cases.

** Introducing The Redux Store 
Now that we have a reducer, we can start looking at how this all plugs into
Redux itself.

As we just saw, if you had a collection of all the actions that are ever going
to occur in your application, you could just call reduce. Out pops the final
state of your app. Of course, you usually don't have a collection of all those
actions. They will arrive spread out over time, as things happen in the world:
When users interact with the app, when data is received from networks, or when
timeouts trigger.

To deal with this reality, we can use a Redux Store. It is an object that, as
the name implies, stores the state of your application over time.

A Redux Store is initialized with a reducer function, such as the one we have
just implemented:

Now that we have a reducer, we can start looking at how this all plugs into
Redux itself.

As we just saw, if you had a collection of all the actions that are ever going
to occur in your application, you could just call reduce. Out pops the final
state of your app. Of course, you usually don't have a collection of all those
actions. They will arrive spread out over time, as things happen in the world:
When users interact with the app, when data is received from networks, or when
timeouts trigger.

To deal with this reality, we can use a Redux Store. It is an object that, as
the name implies, stores the state of your application over time.

A Redux Store is initialized with a reducer function, such as the one we have
just implemented:

import {createStore} from 'redux';

const store = createStore(reducer);

What you can then do is dispatch actions to that Store. The Store will
internally use your reducer to apply the actions to the current state, and
store the resulting, next state:

store.dispatch({type: 'NEXT'});

At any point in time, you can obtain the current state from inside the Store:

store.getState();

We're going to set up and export a Redux Store in a file called store.js. Let's
test it first. We should be able to make a store, read its initial state,
dispatch action, and witness the changed state:
import {createStore} from 'redux';

const store = createStore(reducer);

What you can then do is dispatch actions to that Store. The Store will
internally use your reducer to apply the actions to the current state, and
store the resulting, next state:

store.dispatch({type: 'NEXT'});

At any point in time, you can obtain the current state from inside the Store:

store.getState();

We're going to set up and export a Redux Store in a file called store.js. Let's
test it first. We should be able to make a store, read its initial state,
dispatch action, and witness the changed state:

test/store_spec.js
import {Map, fromJS} from 'immutable';
import {expect} from 'chai';

import makeStore from '../src/store';

describe('store', () => {

  it('is a Redux store configured with the correct reducer', () => {
    const store = makeStore();
    expect(store.getState()).to.equal(Map());

    store.dispatch({
      type: 'SET_ENTRIES',
      entries: ['Trainspotting', '28 Days Later']
    });
    expect(store.getState()).to.equal(fromJS({
      entries: ['Trainspotting', '28 Days Later']
    }));
  });

});

Before we can create the Store, we need to add Redux into the project:

#+BEGIN_SRC sh
npm install --save redux
#+END_SRC

#+RESULTS:
: redux@3.0.4 node_modules/redux

Then we can create store.js, where we simply call createStore with our reducer:

src/store.js
import {createStore} from 'redux';
import reducer from './reducer';

export default function makeStore() {
  return createStore(reducer);
}

So, the Redux store ties things together into something we'll be able to use as
the central point of our application: It holds the current state, and over time
can receive actions that evolve the state from one version to the next, using
the core application logic we have written and exposed through the reducer.
Question: How many variables do you need in a Redux application?
Answer: One. The one inside the store. 

This notion may sound ludicrous at first - at least if you haven't done much
functional programming. How can you do anything useful with just one variable? 

But the fact is we don't need any more variables than that. The current state
tree is the only thing that varies over time in our core application. The rest
is all constants and immutable values. 

It is quite remarkable just how small the integration surface area between our
application code and Redux actually is. Because we have a generic reducer
function, that's the only thing we need to let Redux know about. The rest is
all in our own, non-framework-specific, highly portable and purely functional
code!

If we now create the index.js entry point for the application, we can have it
create and export a store:

index.js
import makeStore from './src/store';

export const store = makeStore();

Since we also export the store, you could now fire up a Node REPL (with e.g.
babel-node), require the index.js file and interact with the application using
the store.

** Setting Up a Socket.io Server 
#+BEGIN_SRC sh 
npm install --save socket.io
#+END_SRC
This creates a Socket.io server, as well as a regular HTTP server bound to port
8090. The choice of port is arbitrary, but it needs to match the port we'll
later use to connect from clients.

We can then have index.js call this function, so that a server is started when
the app starts:

index.js
import makeStore from './src/store';
import startServer from './src/server';

export const store = makeStore();
startServer();

If we now add a start command to our package.json, we'll make startup a bit
simpler:

package.json
"scripts": {
  "start": "babel-node index.js",
  "test": "mocha --compilers js:babel-core/register  --require ./test/test_helper.js  --recursive",
  "test:watch": "npm run test -- --watch"
},

Now we can simply start the server (and create the Redux store) by typing:

npm run start

The babel-node command comes from the babel-cli package that we installed
earlier. It allows us to easily run Node code with Babel transpiling support
enabled. It adds some performance overhead so it isn't generally recommended
for production use, but it works well for the purposes of our tutorial. 

** Broadcasting State from A Redux Listener 

We have a Socket.io server and we have a Redux state container but they aren't
yet integrated in any way. The next thing we'll do is change that.

Our server should be able to let clients know about the current state of the
application (i.e. "what is being voted on?", "What is the current tally of
votes?", "Is there a winner yet?"). It can do so by emitting a Socket.io event
to all connected clients whenever something changes.

And how can we know when something has changed? Well, Redux provides something
for exactly this purpose: You can subscribe to a Redux store. You do that by
providing a function that the store will call after every action it applies,
when the state has potentially changed. It is essentially a callback to state
changes within the store.

We'll do this in startServer, so let's give it the Redux store first:

index.js
import makeStore from './src/store';
import {startServer} from './src/server';

export const store = makeStore();
startServer(store);

What we'll do is subscribe a listener to the store that reads the current
state, turns it into a plain JavaScript object, and emits it as a state event
on the Socket.io server. The result will be that a JSON-serialized snapshot of
the state is sent over all active Socket.io connections.

src/server.js
import Server from 'socket.io';

export function startServer(store) {
  const io = new Server().attach(8090);

  store.subscribe(
    () => io.emit('state', store.getState().toJS())
  );
}

We are now publishing the whole state to everyone whenever any changes occur.
This may end up causing a lot of data transfer. One could think of various ways
of optimizing this (e.g. just sending the relevant subset, sending diffs
instead of snapshots...), but this implementation has the benefit of being easy
to write, so we'll just use it for our example app. 

In addition to sending a state snapshot whenever state changes, it will be
useful for clients to immediately receive the current state when they connect
to the application. That lets them sync their client-side state to the latest
server state right away.

We can listen to 'connection' events on our Socket.io server. We get one each
time a client connects. In the event listener we can emit the current state
right away:

src/server.js
import Server from 'socket.io';

export function startServer(store) {
  const io = new Server().attach(8090);

  store.subscribe(
    () => io.emit('state', store.getState().toJS())
  );

  io.on('connection', (socket) => {
    socket.emit('state', store.getState().toJS());
  });

}

** Receiving Remote Redux Actions 
   CLOCK: [2015-11-26 বৃহঃ 12:07]--[2015-11-26 বৃহঃ 13:07] =>  1:00

In addition to emitting the application state out to clients, we should also be
able to receive updates from them: Voters will be assigning votes, and the vote
organizer will be moving the contest forward using the NEXT action.

The solution we'll use for this is actually quite simple. What we can do is
simply have our clients emit 'action' events that we feed directly into our
Redux store:

src/server.js
import Server from 'socket.io';

export function startServer(store) {
  const io = new Server().attach(8090);

  store.subscribe(
  () => io.emit('state', store.getState().toJS())
  );

  io.on('connection', (socket) => {
    socket.emit('state', store.getState().toJS());
    socket.on('action', store.dispatch.bind(store));
  });

}

This is where we start to go beyond "regular Redux", since we are now
essentially accepting remote actions into our store. However, the Redux
architecture makes it remarkably easy to do: Since actions are just JavaScript
objects, and JavaScript objects can easily be sent over the network, we
immediately got a system with which any number of clients can participate in
voting. That's no small feat!

There are some obvious security considerations here. We're allowing any
connected Socket.io client to dispatch any action into the Redux store. 

In most real-world cases, there should be some kind of firewall here, probably
not dissimilar to the one in the Vert.x Event Bus Bridge. Apps that have an
authentication mechanism should also plug it in here. 

Our server now operates essentially like this:

1 A client sends an action to the server. 
2 The server hands the action to the Redux Store. 
3 The Store calls the reducer and the reducer executes the logic related to the
  action. 
4 The Store updates its state based on the return value of the reducer. 
5 The Store executes the listener function subscribed by the server. 
6 The server emits a 'state' event. 
7 All connected clients - including the one that initiated the original action -
  receive the new state. 

Before we're done with the server, let's have it load up a set of test entries
for us to play with, so that we have something to look at once we have the
whole system going. We can add an entries.json file that lists the contest
entries. For example, the list of Danny Boyle's feature films to date - feel
free to substitute your favorite subject matter though!

entries.json
[
  "Shallow Grave",
  "Trainspotting",
  "A Life Less Ordinary",
  "The Beach",
  "28 Days Later",
  "Millions",
  "Sunshine",
  "Slumdog Millionaire",
  "127 Hours",
  "Trance",
  "Steve Jobs"
]

We can just load this in into index.js and then kick off the vote by
dispatching a NEXT action:

index.js
import makeStore from './src/store';
import {startServer} from './src/server';

export const store = makeStore();
startServer(store);

store.dispatch({
  type: 'SET_ENTRIES',
  entries: require('./entries.json')
});
store.dispatch({type: 'NEXT'});

And with that, we're ready to switch our focus to the client application.

* The Client Application 
** Introduction 
During the remainder of this tutorial we'll be writing a React application that
connects to the server we now have and makes the voting system come alive to
users.

We're going to use Redux again on the client. This is arguably the most common
use case for Redux: As the underlying engine of a React application. We've
already seen how Redux itself works, and soon we'll learn exactly how it fits
together with React and how using it influences the design of React apps.

** DONE Client Project Setup 
*** Introduction
The very first thing we're going to do is start a fresh NPM project, just like
we did with the server.

mkdir voting-client
cd voting-client

#+BEGIN_SRC sh 
npm init -y
#+END_SRC

#+RESULTS:

We're going to need an HTML host page for the app. Let's put that in dist/index.html:

dist/index.html
<!DOCTYPE html>
<html>
<body>
  <div id="app"></div>
  <script src="bundle.js"></script>
</body>
</html>

This document just contains a <div> with id app, into which we'll put our application. It expects
there to be a JavaScript file called bundle.js in the same directory.

Let's also create the first JavaScript file for this app. This will be the application's entry point
file. For now we can just put a simple logging statement in it:

src/index.js
console.log('I am alive!');

To ease our client development workflow, we're going to use Webpack along with its development server,
so let's add both to the project:

#+BEGIN_SRC sh
npm install --save-dev webpack webpack-dev-server
#+END_SRC

#+RESULTS:
| webpack-dev-server@1.14.0 | node_modules/webpack-dev-server    |                          |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | connect-history-api-fallback@1.1.0 |                          |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | stream-cache@0.0.2                 |                          |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | strip-ansi@3.0.0                   | (ansi-regex@2.0.0)       |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | supports-color@3.1.2               | (has-flag@1.0.0)         |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | http-proxy@1.12.0                  | (eventemitter3@1.1.1,    | requires-port@0.0.1)        |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | optimist@0.6.1                     | (wordwrap@0.0.3,         | minimist@0.0.10)            |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | compression@1.6.0                  | (bytes@2.1.0,            | on-headers@1.0.1,           | vary@1.1.0,                 | compressible@2.0.6,    | debug@2.2.0,       | accepts@1.3.0)          |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | express@4.13.3                     | (escape-html@1.0.2,      | merge-descriptors@1.0.0,    | cookie@0.1.3,               | array-flatten@1.1.1,   | utils-merge@1.0.0, | content-type@1.0.1,     | cookie-signature@1.0.6, | vary@1.0.1,     | methods@1.1.1,        | range-parser@1.0.3, | content-disposition@0.5.0, | serve-static@1.10.0,     | fresh@0.3.0,             | etag@1.7.0,   | path-to-regexp@0.1.7, | parseurl@1.3.0,         | depd@1.0.1,               | qs@4.0.0,    | on-finished@2.3.0, | finalhandler@0.4.0,    | debug@2.2.0,  | proxy-addr@1.0.8,      | accepts@1.2.13,          | send@0.13.0, | type-is@1.6.9) |
| ├──                       | webpack-dev-middleware@1.4.0       | (mime@1.3.4,             | memory-fs@0.3.0)            |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | sockjs@0.3.15                      | (node-uuid@1.4.7,        | faye-websocket@0.9.4)       |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | serve-index@1.7.2                  | (escape-html@1.0.2,      | parseurl@1.3.0,             | batch@0.5.2,                | http-errors@1.3.1,     | mime-types@2.1.7,  | accepts@1.2.13,         | debug@2.2.0)            |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| └──                       | sockjs-client@1.0.3                | (json3@3.3.2,            | inherits@2.0.1,             | debug@2.2.0,                | url-parse@1.0.5,       | eventsource@0.1.6, | faye-websocket@0.7.3)   |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
|                           |                                    |                          |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| webpack@1.12.9            | node_modules/webpack               |                          |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | interpret@0.6.6                    |                          |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | tapable@0.1.10                     |                          |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | clone@1.0.2                        |                          |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | async@1.5.0                        |                          |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | esprima@2.7.0                      |                          |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | supports-color@3.1.2               | (has-flag@1.0.0)         |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | enhanced-resolve@0.9.1             | (graceful-fs@4.1.2,      | memory-fs@0.2.0)            |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | mkdirp@0.5.1                       | (minimist@0.0.8)         |                             |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | memory-fs@0.3.0                    | (errno@0.1.4,            | readable-stream@2.0.4)      |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | optimist@0.6.1                     | (wordwrap@0.0.3,         | minimist@0.0.10)            |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | webpack-core@0.6.8                 | (source-map@0.4.4,       | source-list-map@0.1.5)      |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | uglify-js@2.6.1                    | (async@0.2.10,           | uglify-to-browserify@1.0.2, | source-map@0.5.3,           | yargs@3.10.0)          |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | loader-utils@0.2.12                | (big.js@3.1.3,           | json5@0.4.0)                |                             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| ├──                       | watchpack@0.2.9                    | (graceful-fs@4.1.2,      | async@0.9.2,                | chokidar@1.3.0)             |                        |                    |                         |                         |                 |                       |                     |                            |                          |                          |               |                       |                         |                           |              |                    |                        |               |                        |                          |              |                |
| └──                       | node-libs-browser@0.5.3            | (https-browserify@0.0.0, | tty-browserify@0.0.0,       | constants-browserify@0.0.1, | path-browserify@0.0.0, | punycode@1.3.2,    | string_decoder@0.10.31, | os-browserify@0.1.2,    | process@0.11.2, | domain-browser@1.1.4, | assert@1.3.0,       | querystring-es3@0.2.1,     | timers-browserify@1.4.1, | stream-browserify@1.0.0, | events@1.1.0, | vm-browserify@0.0.4,  | readable-stream@1.1.13, | console-browserify@1.1.0, | util@0.10.3, | url@0.10.3,        | http-browserify@1.7.0, | buffer@3.5.2, | browserify-zlib@0.1.4, | crypto-browserify@3.2.8) |              |                |

If you don't have them already, also install the same packages globally so that you'll be able to
conveniently launch them from the command line: npm install -g webpack webpack-dev-server. 

Next, let's add a Webpack configuration file at the root of the project, that matches the files and
directories we've created:

#+BEGIN_SRC sh
npm install --save-dev babel-core babel-loader babel-preset-es2015 babel-preset-react
#+END_SRC

#+RESULTS:
| babel-loader@6.2.0         | node_modules/babel-loader                                   |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | object-assign@4.0.1                                         |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| └──                        | loader-utils@0.2.12                                         | (big.js@3.1.3,                               | json5@0.4.0)                                  |                                    |                                   |                                |                       |                    |                       |                       |
|                            |                                                             |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| babel-preset-react@6.1.18  | node_modules/babel-preset-react                             |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-flow-strip-types@6.1.18              | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-react-display-name@6.1.18            | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-syntax-flow@6.1.18                             | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-react-jsx-source@6.1.18              | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-syntax-jsx@6.1.18                              | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| └──                        | babel-plugin-transform-react-jsx@6.2.0                      | (babel-helper-builder-react-jsx@6.2.0,       | babel-runtime@5.8.34)                         |                                    |                                   |                                |                       |                    |                       |                       |
|                            |                                                             |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| babel-core@6.2.1           | node_modules/babel-core                                     |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | slash@1.0.0                                                 |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-messages@6.2.1                                        |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-template@6.2.0                                        |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | path-exists@1.0.0                                           |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | shebang-regex@1.0.0                                         |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | path-is-absolute@1.0.0                                      |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-helpers@6.1.20                                        |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | private@0.1.6                                               |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | convert-source-map@1.1.2                                    |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | source-map@0.5.3                                            |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | debug@2.2.0                                                 | (ms@0.7.1)                                   |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babylon@6.2.0                                               |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-types@6.2.0                                           | (to-fast-properties@1.0.1,                   | esutils@2.0.2)                                |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | minimatch@2.0.10                                            | (brace-expansion@1.1.1)                      |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-code-frame@6.1.18                                     | (js-tokens@1.0.2,                            | esutils@2.0.2,                                | line-numbers@0.2.0,                | chalk@1.1.1,                      | repeating@1.1.3)               |                       |                    |                       |                       |
| ├──                        | babel-generator@6.2.0                                       | (trim-right@1.0.1,                           | repeating@1.1.3,                              | is-integer@1.0.6,                  | detect-indent@3.0.1)              |                                |                       |                    |                       |                       |
| ├──                        | babel-traverse@6.2.0                                        | (globals@8.12.1,                             | repeating@1.1.3,                              | invariant@2.2.0)                   |                                   |                                |                       |                    |                       |                       |
| ├──                        | json5@0.4.0                                                 |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | lodash@3.10.1                                               |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-register@6.2.0                                        | (home-or-tmp@1.0.0,                          | source-map-support@0.2.10,                    | core-js@1.2.6)                     |                                   |                                |                       |                    |                       |                       |
| └──                        | babel-runtime@5.8.34                                        | (core-js@1.2.6)                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
|                            |                                                             |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| babel-preset-es2015@6.1.18 | node_modules/babel-preset-es2015                            |                                              |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-block-scoped-functions@6.1.18 | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-check-es2015-constants@6.2.0                   | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-computed-properties@6.1.18    | (babel-template@6.2.0,                       | babel-helper-define-map@6.2.0,                | babel-runtime@5.8.34)              |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-arrow-functions@6.1.18        | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-destructuring@6.1.18          | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-spread@6.1.18                 | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-for-of@6.1.18                 | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-function-name@6.1.18          | (babel-types@6.2.0,                          | babel-helper-function-name@6.2.0,             | babel-runtime@5.8.34)              |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-unicode-regex@6.1.18          | (regexpu@1.3.0,                              | babel-helper-regex@6.1.18,                    | babel-runtime@5.8.34)              |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-sticky-regex@6.1.18           | (babel-helper-regex@6.1.18,                  | babel-types@6.2.0,                            | babel-runtime@5.8.34)              |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-object-super@6.1.18           | (babel-helper-replace-supers@6.2.0,          | babel-runtime@5.8.34)                         |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-template-literals@6.1.18      | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-typeof-symbol@6.1.18          | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-literals@6.1.18               | (babel-runtime@5.8.34)                       |                                               |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-shorthand-properties@6.1.18   | (babel-types@6.2.0,                          | babel-runtime@5.8.34)                         |                                    |                                   |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-modules-commonjs@6.2.0        | (babel-plugin-transform-strict-mode@6.2.0,   | babel-template@6.2.0,                         | babel-types@6.2.0,                 | babel-runtime@5.8.34)             |                                |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-parameters@6.1.18             | (babel-helper-get-function-arity@6.2.0,      | babel-helper-call-delegate@6.2.0,             | babel-template@6.2.0,              | babel-types@6.2.0,                | babel-traverse@6.2.0,          | babel-runtime@5.8.34) |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-block-scoping@6.1.18          | (babel-types@6.2.0,                          | babel-template@6.2.0,                         | babel-traverse@6.2.0,              | lodash@3.10.1,                    | babel-runtime@5.8.34)          |                       |                    |                       |                       |
| ├──                        | babel-plugin-transform-es2015-classes@6.2.2                 | (babel-messages@6.2.1,                       | babel-helper-optimise-call-expression@6.1.18, | babel-helper-replace-supers@6.2.0, | babel-helper-function-name@6.2.0, | babel-helper-define-map@6.2.0, | babel-template@6.2.0, | babel-types@6.2.0, | babel-traverse@6.2.0, | babel-runtime@5.8.34) |
| └──                        | babel-plugin-transform-regenerator@6.2.0                    | (babel-plugin-syntax-async-functions@6.1.18, | private@0.1.6,                                | babylon@6.2.0,                     | babel-types@6.2.0,                | babel-traverse@6.2.0,          | babel-runtime@5.8.34) |                    |                       |                       |


You should now be able to run Webpack to produce bundle.js:

webpack

You should also be able to start the dev server, after which the test page (including the logging
statement from index.js) should be accessible in localhost:8080.

webpack-dev-server --host=ip

In this tutorial we won't be spending any time on CSS. If you'd like the app to look nicer, you can of
course add your own styles as you go along. 

Alternatively, you can grab some styling from this commit. In addition to a CSS file, it adds Webpack
support for including (and autoprefixing) it, as well as a slightly improved result visualization
component. 

*** Unit Testing support 

We'll be writing some unit tests for the client code too. We can use the same unit test libraries that
we used on the server - Mocha and Chai - to test it:
#+BEGIN_SRC sh
npm install --save-dev mocha chai
#+END_SRC

#+RESULTS:
| chai@3.4.1  | node_modules/chai          |                     |                    |                   |
| ├──         | assertion-error@1.0.1      |                     |                    |                   |
| ├──         | type-detect@1.0.0          |                     |                    |                   |
| └──         | deep-eql@0.1.3             | (type-detect@0.1.1) |                    |                   |
|             |                            |                     |                    |                   |
| mocha@2.3.4 | node_modules/mocha         |                     |                    |                   |
| ├──         | escape-string-regexp@1.0.2 |                     |                    |                   |
| ├──         | diff@1.4.0                 |                     |                    |                   |
| ├──         | commander@2.3.0            |                     |                    |                   |
| ├──         | supports-color@1.2.0       |                     |                    |                   |
| ├──         | growl@1.8.1                |                     |                    |                   |
| ├──         | debug@2.2.0                | (ms@0.7.1)          |                    |                   |
| ├──         | mkdirp@0.5.0               | (minimist@0.0.8)    |                    |                   |
| ├──         | jade@0.26.3                | (commander@0.6.1,   | mkdirp@0.3.0)      |                   |
| └──         | glob@3.2.3                 | (inherits@2.0.1,    | graceful-fs@2.0.3, | minimatch@0.2.14) |


We're going to test our React components as well, and that's going to require a DOM. One alternative
would be to run tests in an actual web browser with a library like Karma. However, we don't actually
need to do that because we can get away with using jsdom, a pure JavaScript DOM implementation that
runs in Node:
#+BEGIN_SRC sh
npm install --save-dev jsdom
#+END_SRC

#+RESULTS:
| jsdom@7.1.0 | node_modules/jsdom       |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | acorn-globals@1.0.9      |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | webidl-conversions@2.0.1 |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | xml-name-validator@2.0.1 |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | abab@1.0.1               |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | symbol-tree@3.1.4        |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | tough-cookie@2.2.1       |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | nwmatcher@1.3.7          |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | cssom@0.3.0              |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | whatwg-url-compat@0.6.5  | (tr46@0.0.2)           |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | parse5@1.5.0             |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | acorn@2.6.4              |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | escodegen@1.7.1          | (estraverse@1.9.3,     | esutils@2.0.2,       | esprima@1.2.5,          | optionator@0.5.0, | source-map@0.2.0) |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | htmlparser2@3.8.3        | (domelementtype@1.3.0, | entities@1.0.0,      | readable-stream@1.1.13, | domhandler@2.3.0, | domutils@1.5.1)   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |
| ├──         | request@2.67.0           | (aws-sign2@0.6.0,      | forever-agent@0.6.1, | tunnel-agent@0.4.1,     | oauth-sign@0.8.0, | caseless@0.11.0,  | is-typedarray@1.0.0, | stringstream@0.0.5, | isstream@0.1.2, | json-stringify-safe@5.0.1, | extend@3.0.0, | node-uuid@1.4.7, | qs@5.2.0, | combined-stream@1.0.5, | mime-types@2.1.7, | form-data@1.0.0-rc3, | hawk@3.1.2, | bl@1.0.0, | http-signature@1.1.0, | har-validator@2.0.3) |
| └──         | cssstyle@0.2.30          |                        |                      |                         |                   |                   |                      |                     |                 |                            |               |                  |           |                        |                   |                      |             |           |                       |                      |


The latest versions of jsdom require io.js or Node.js 4.0.0. If you are running an older Node version,
you need to explicitly install an older version: npm install --save-dev jsdom@3 

We also need a bit of setup code for jsdom before it's ready for React to use. We essentially need to
create jsdom versions of the document and window objects that would normally be provided by the web
browser. Then we need to put them on the global object, so that they will be discovered by React when
it accesses document or window. We can set up a test helper file for this kind of setup code:

test/test_helper.js
import jsdom from 'jsdom';

const doc = jsdom.jsdom('<!doctype html><html><body></body></html>');
const win = doc.defaultView;

global.document = doc;
global.window = win;

Additionally, we need to take all the properties that the jsdom window object contains, such as
navigator, and hoist them on to the Node.js global object. This is done so that properties provided by
window can be used without the window. prefix, which is what would happen in a browser environment.
Some of the code inside React relies on this:

test/test_helper.js
import jsdom from 'jsdom';

const doc = jsdom.jsdom('<!doctype html><html><body></body></html>');
const win = doc.defaultView;

global.document = doc;
global.window = win;

Object.keys(window).forEach((key) => {
  if (!(key in global)) {
    global[key] = window[key];
  }
});

We're also going to be using Immutable collections, so we need to repeat the same trick we applied on
the server to add Chai expectation support for them. We should install both the immutable and the
chai-immutable package:
#+BEGIN_SRC sh
npm install --save immutable
npm install --save-dev chai-immutable

#+END_SRC

#+RESULTS:
| immutable@3.7.5      | node_modules/immutable      |
| chai-immutable@1.5.3 | node_modules/chai-immutable |

Then we should enable it in the test helper file:

test/test_helper.js
import jsdom from 'jsdom';
import chai from 'chai';
import chaiImmutable from 'chai-immutable';

const doc = jsdom.jsdom('<!doctype html><html><body></body></html>');
const win = doc.defaultView;

global.document = doc;
global.window = win;

Object.keys(window).forEach((key) => {
  if (!(key in global)) {
    global[key] = window[key];
  }
});

chai.use(chaiImmutable);

The final step before we can run tests is to come up with the command that will run them, and put it
in our package.json. Here it is:

package.json
"scripts": {
  "test": "mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'"
},

This is almost the same command that we used in the server's package.json. There only difference is in
the test file specification: On the server we just used --recursive, but that option won't find .jsx
files. We need to use a glob that will find all .js and .jsx test files.

It will be useful to continuously run tests whenever code changes occur. We can add a test:watch
command for this. It is identical to the one for the server:

package.json
"scripts": {
  "test": "mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'",
  "test:watch": "npm run test -- --watch"
},

*** React and react-hot-loader

With the Webpack and Babel infrastructure in place, let's talk about React!

What's really cool about the way React applications get built with Redux and Immutable is that we can
write everything as so-called Pure Components (also sometimes called "Dumb Components"). As a concept,
this is similar to pure functions, in that there are a couple of rules to follow:

1 A pure component receives all its data as props, like a function receives all its data as arguments.
  It should have no side effects, including reading data from anywhere else, initiating network
  requests, etc. 
2 A pure component generally has no internal state. What it renders is fully driven by its input
  props. Rendering the same pure component twice with the same props should result in the same UI.
  There's no hidden state inside the component that would cause the UI to differ between the two
  renders. 

This has a similar simplifying effect as using pure functions does: We can figure out what a component
does by looking at what it receives as inputs and what it renders. There's nothing else we need to
know about the component. We can also test it really easily - almost as easily as we were able to test
our pure application logic.

If components can't have state, where will the state be? In an immutable data structure inside a Redux
store! We've already seen how that works. The big idea is to separate the state from the user
interface code. The React components are just a stateless projection of the state at a given point in
time.

But, first things first, let's go ahead and add React to the project:
#+BEGIN_SRC sh
npm install --save react react-dom
#+END_SRC

#+RESULTS:
| react-dom@0.14.3 | node_modules/react-dom |                      |                     |                     |                |                |
|                  |                        |                      |                     |                     |                |                |
| react@0.14.3     | node_modules/react     |                      |                     |                     |                |                |
| ├──              | envify@3.4.0           | (through@2.3.8,      | jstransform@10.1.0) |                     |                |                |
| └──              | fbjs@0.3.2             | (whatwg-fetch@0.9.0, | ua-parser-js@0.7.9, | loose-envify@1.1.0, | promise@7.0.4, | core-js@1.2.6) |

We should also set up react-hot-loader. It will make our development workflow much faster by reloading
code for us without losing the current state of the app.
#+BEGIN_SRC sh
npm install --save-dev react-hot-loader
#+END_SRC

#+RESULTS:
| react-hot-loader@1.3.0 | node_modules/react-hot-loader |                  |
| ├──                    | react-hot-api@0.4.7           |                  |
| └──                    | source-map@0.4.4              | (amdefine@1.0.0) |

It would be silly of us not to use react-hot-loader, since we'll have an architecture that makes using
it really easy. In fact, the creation of both Redux and react-hot-loader are all part of the same
story! 

We need to make several updates to webpack.config.js to enable the hot loader. Here's the updated
version:

webpack.config.js
var webpack = require('webpack');

module.exports = {
  entry: [
    'webpack-dev-server/client?http://localhost:8080',
    'webpack/hot/only-dev-server',
    './src/index.js'
  ],
  module: {
    loaders: [{
      test: /\.jsx?$/,
      exclude: /node_modules/,
      loader: 'react-hot!babel'
    }]
  },
  resolve: {
    extensions: ['', '.js', '.jsx']
  },
  output: {
    path: __dirname + '/dist',
    publicPath: '/',
    filename: 'bundle.js'
  },
  devServer: {
    contentBase: './dist',
    hot: true
  },
  plugins: [
    new webpack.HotModuleReplacementPlugin()
  ]
};

In the entry section we include two new things to our app's entry points: The client-side library of
the Webpack dev server and the Webpack hot module loader. These provide the Webpack infrastructure for
hot module replacement. The hot module replacement support isn't loaded by default, so we also need to
load its plugin in the plugins section and enable it in the devServer section.

In the loaders section we configure the react-hot loader to be used with our .js and .jsx files, in
addition to Babel.

If you now start or restart the development server, you should see a message about Hot Module
Replacement being enabled in the console. We're good to go ahead with writing our first component.

*** Writing The UI for The Voting Screen 
    CLOCK: [2015-11-27 Fri 04:10]--[2015-11-27 Fri 06:05] =>  1:55

**** The voting screen
***** Introduction
The application will be quite simple: While voting is ongoing, it'll always
display two buttons - one for each of the entries being voted on. When the vote is over, it'll display
the winner.

We've been mainly doing test-first development so far, but for the React components we'll switch our
workflow around: We'll write the components first and the tests second. This is because Webpack and
react-hot-loader provide an even tighter feedback loop for development than unit tests do. Also,
there's no better feedback when writing a UI than to actually see it in action!

Let's just assume we're going to have a Voting component and render it in the application entry point.
We can mount it into the #app div that we added to index.html earlier. We should also rename index.js
to index.jsx since it'll now contain some JSX markup:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Voting from './components/Voting';

const pair = ['Trainspotting', '28 Days Later'];

ReactDOM.render(
  <Voting pair={pair} />,
  document.getElementById('app')
);

****** changle entrypoint

The entrypoint filename must also be changed in webpack.config.js:

webpack.config.js
entry: [
  'webpack-dev-server/client?http://localhost:8080',
  'webpack/hot/only-dev-server',
  './src/index.jsx'
],

If you start (or restart) webpack-dev-server now, you'll see it complain about the missing Voting
component. Let's fix that by writing our first version of it:
   

**** The Voting component 
takes the current pair of entries as props. For now we can just hardcode that
pair, and later we'll substitute it with real data. The component itself is pure and doesn't care
where the data comes from.


src/components/Voting.jsx
import React from 'react';

export default React.createClass({
  getPair: function() {
    return this.props.pair || [];
  },
  render: function() {
    return <div className="voting">
      {this.getPair().map(entry =>
        <button key={entry}>
          <h1>{entry}</h1>
        </button>
      )}
    </div>;
  }
});

This renders the pair of entries as buttons. You should be able to see them in your web browser. Try
making some changes to the component code and see how they're immediately applied in the browser. No
restarts, no page reloads. Talk about fast feedback!

If you don't see what you expect, check the webpack-dev-server output as well as the console log in
your browser's development tools for problems. 

**** Now we can add our first unit test as well
***** Introduction
for the functionality that we've got. It'll go in a file
called Voting_spec.jsx:

test/components/Voting_spec.jsx
import Voting from '../../src/components/Voting';

describe('Voting', () => {

});

***** renderIntoDocument

To test that the component renders those buttons based on the pair prop, we should render it and see
what the output was. To render a component in a unit test, we can use a helper function called
renderIntoDocument, which will be in react/addons:

test/components/Voting_spec.jsx
import React from 'react/addons';
import Voting from '../../src/components/Voting';

const {renderIntoDocument} = React.addons.TestUtils;

describe('Voting', () => {

  it('renders a pair of buttons', () => {
    const component = renderIntoDocument(
      <Voting pair={["Trainspotting", "28 Days Later"]} />
    );
  });

});

***** scryRenderedDOMComponentsWithTag
Once the component is rendered, we can use another React helper function called
scryRenderedDOMComponentsWithTag to find the button elements we expect there to be. We expect two of
them, and we expect their text contents to be the two entries, respectively:

test/components/Voting_spec.jsx
import React from 'react/addons';
import Voting from '../../src/components/Voting';
import {expect} from 'chai';

const {renderIntoDocument, scryRenderedDOMComponentsWithTag}
  = React.addons.TestUtils;

describe('Voting', () => {

  it('renders a pair of buttons', () => {
    const component = renderIntoDocument(
      <Voting pair={["Trainspotting", "28 Days Later"]} />
    );
    const buttons = scryRenderedDOMComponentsWithTag(component, 'button');

    expect(buttons.length).to.equal(2);
    expect(buttons[0].textContent).to.equal('Trainspotting');
    expect(buttons[1].textContent).to.equal('28 Days Later');
  });

});

If you run the test now, you should see it pass:
***** Test: renders a pair of buttons
#+BEGIN_SRC sh :results verbatim
npm run test
#+END_SRC

#+RESULTS:
#+begin_example

> voting-client@1.0.0 test /usr/local/src/jstutorials/voting-client
> mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'



  Voting
    ✓ renders a poir of buttons


  1 passing (63ms)

#+end_example

***** Simulating
the component should invoke a callback function. Like the
entry pair, the callback function should also be given to the component as a prop.

Let's go ahead and add a unit test for this too. We can test this by simulating a click using the
Simulate object from React's test utilities:

test/components/Voting_spec.jsx
import React from 'react/addons';
import Voting from '../../src/components/Voting';
import {expect} from 'chai';

const {renderIntoDocument, scryRenderedDOMComponentsWithTag, Simulate}
  = React.addons.TestUtils;

describe('Voting', () => {

  // ...

  it('invokes callback when a button is clicked', () => {
    let votedWith;
    const vote = (entry) => votedWith = entry;

    const component = renderIntoDocument(
      <Voting pair={["Trainspotting", "28 Days Later"]}
              vote={vote}/>
    );
    const buttons = scryRenderedDOMComponentsWithTag(component, 'button');
    Simulate.click(buttons[0]);

    expect(votedWith).to.equal('Trainspotting');
  });

});

***** Onclick handler
Getting this test to pass is simple enough. We just need an onClick handler on the buttons that
invokes vote with the correct entry:

src/components/Voting.jsx
import React from 'react';

export default React.createClass({
  getPair: function() {
    return this.props.pair || [];
  },
  render: function() {
    return <div className="voting">
      {this.getPair().map(entry =>
        <button key={entry}
                onClick={() => this.props.vote(entry)}>
          <h1>{entry}</h1>
        </button>
      )}
    </div>;
  }
});

#+BEGIN_SRC sh :results verbatim
npm run test
#+END_SRC

#+RESULTS:
#+begin_example

> voting-client@1.0.0 test /usr/local/src/jstutorials/voting-client
> mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'



  Voting
    ✓ renders a poir of buttons
    ✓ invokes callback when a button is clicked


  2 passing (63ms)

#+end_example


This is generally how we'll manage user input and actions with pure components: The components don't
try to do much about those actions themselves. They merely invoke callback props.

Here we switched back to test-first development by writing the test first and the functionality
second. I find it's often easier to initially test user input code from tests than through the
browser. 

In general, we'll be switching between the test-first and test-last workflows during UI development,
based on whichever feels more useful at each step. 

**** Once the user has already voted for a pair
     we probably shouldn't let them vote again. While we could
handle this internally in the component state, we're really trying to keep our components pure, so we
should try to externalize that logic. The component could just take a hasVoted prop, for which we'll
just hardcode a value for now:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Voting from './components/Voting';

const pair = ['Trainspotting', '28 Days Later'];

ReactDOM.render(
  <Voting pair={pair} hasVoted="Trainspotting" />,
  document.getElementById('app')
);

   

We can make this work quite easily:

src/components/Voting.jsx
import React from 'react';

export default React.createClass({
  getPair: function() {
    return this.props.pair || [];
  },
  isDisabled: function() {
    return !!this.props.hasVoted;
  },
  render: function() {
    return <div className="voting">
      {this.getPair().map(entry =>
        <button key={entry}
                disabled={this.isDisabled()}
                onClick={() => this.props.vote(entry)}>
          <h1>{entry}</h1>
        </button>
      )}
    </div>;
  }
});

***** Let's also add a little label to the button 
that the user has voted on, so that it is clear to them
what has happened. The label should become visible for the button whose entry matches the hasVoted
prop. We can make a new helper method hasVotedFor to decide whether to render the label or not:

src/components/Voting.jsx
import React from 'react';

export default React.createClass({
  getPair: function() {
    return this.props.pair || [];
  },
  isDisabled: function() {
    return !!this.props.hasVoted;
  },
  hasVotedFor: function(entry) {
    return this.props.hasVoted === entry;
  },
  render: function() {
    return <div className="voting">
      {this.getPair().map(entry =>
        <button key={entry}
                disabled={this.isDisabled()}
                onClick={() => this.props.vote(entry)}>
          <h1>{entry}</h1>
          {this.hasVotedFor(entry) ?
            <div className="label">Voted</div> :
            null}
        </button>
      )}
    </div>;
  }
});

**** Winners 
***** The final requirement 
for the voting screen is that once there is a winner, it will show just that,
instead of trying to render any voting buttons. There might another prop for the winner. Again, we can
simply hardcode a value for it temporarily until we have real data to plug in:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Voting from './components/Voting';

const pair = ['Trainspotting', '28 Days Later'];

ReactDOM.render(
  <Voting pair={pair} winner="Trainspotting" />,
  document.getElementById('app')
);

   

***** We could handle this in the component by conditionally rendering a winner div or the buttons:

src/components/Voting.jsx
import React from 'react';

export default React.createClass({
  getPair: function() {
    return this.props.pair || [];
  },
  isDisabled: function() {
    return !!this.props.hasVoted;
  },
  hasVotedFor: function(entry) {
    return this.props.hasVoted === entry;
  },
  render: function() {
    return <div className="voting">
      {this.props.winner ?
        <div ref="winner">Winner is {this.props.winner}!</div> :
        this.getPair().map(entry =>
          <button key={entry}
                  disabled={this.isDisabled()}
                  onClick={() => this.props.vote(entry)}>
            <h1>{entry}</h1>
            {this.hasVotedFor(entry) ?
              <div className="label">Voted</div> :
              null}
          </button>
        )}
    </div>;
  }
});

***** Winner component
This is the functionality that we need, but the rendering code is now slightly messy. It might be
better if we extract some separate components from this, so that the Voting screen component renders
either a Winner component or a Vote component. Starting with the Winner component, it can just render
a div:

src/components/Winner.jsx
import React from 'react';

export default React.createClass({
  render: function() {
    return <div className="winner">
      Winner is {this.props.winner}!
    </div>;
  }
});

The Vote component will be pretty much exactly like the Voting component was before - just concerned
with the voting buttons:

src/components/Vote.jsx
import React from 'react';

export default React.createClass({
  getPair: function() {
    return this.props.pair || [];
  },
  isDisabled: function() {
    return !!this.props.hasVoted;
  },
  hasVotedFor: function(entry) {
    return this.props.hasVoted === entry;
  },
  render: function() {
    return <div className="voting">
      {this.getPair().map(entry =>
        <button key={entry}
                disabled={this.isDisabled()}
                onClick={() => this.props.vote(entry)}>
          <h1>{entry}</h1>
          {this.hasVotedFor(entry) ?
            <div className="label">Voted</div> :
            null}
        </button>
      )}
    </div>;
  }
});

The Voting component itself now merely makes a decision about which of these two components to render:

src/components/Voting.jsx
import React from 'react';
import Winner from './Winner';
import Vote from './Vote';

export default React.createClass({
  render: function() {
    return <div>
      {this.props.winner ?
        <Winner ref="winner" winner={this.props.winner} /> :
        <Vote {...this.props} />}
    </div>;
  }
});

****** Notice that we added a ref for the Winner component. 
It's something we'll use in unit tests to grab the corresponding DOM node.

That's our pure Voting component! Notice how we haven't really implemented any logic yet: There are
buttons but we haven't specified what they do, except invoke a callback. Our components are concerned
with rendering the UI and only that. The application logic will come in later, when we connect the UI
to a Redux store.

Before we move on though, time to writes some more unit tests for the new features we've added.
Firstly, the presence of the hasVoted props should cause the voting buttons to become disabled:

**** Testing HasVoted 
    CLOCK: [2015-11-27 Fri 02:47]--[2015-11-27 Fri 03:36] =>  0:49
test/components/Voting_spec.jsx
it('disables buttons when user has voted', () => {
  const component = renderIntoDocument(
    <Voting pair={["Trainspotting", "28 Days Later"]}
            hasVoted="Trainspotting" />
  );
  const buttons = scryRenderedDOMComponentsWithTag(component, 'button');

  expect(buttons.length).to.equal(2);
  expect(buttons[0].hasAttribute('disabled')).to.equal(true);
  expect(buttons[1].hasAttribute('disabled')).to.equal(true);
});

A 'Voted' label should be present on the button whose entry matches the value of hasVoted:

test/components/Voting_spec.jsx
it('adds label to the voted entry', () => {
  const component = renderIntoDocument(
    <Voting pair={["Trainspotting", "28 Days Later"]}
            hasVoted="Trainspotting" />
  );
  const buttons = scryRenderedDOMComponentsWithTag(component, 'buttons');

  expect(buttons[0].textContent).to.contain('Voted');
});

#+BEGIN_SRC sh :results verbatim
npm run test 
#+END_SRC

#+RESULTS:
#+begin_example

> voting-client@1.0.0 test /usr/local/src/jstutorials/voting-client
> mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'



  Voting
    ✓ renders a poir of buttons
    ✓ invokes callback when a button is clicked
    ✓ disable buttons when user has voted
    ✓ adds label to the voted entry


  4 passing (104ms)

#+end_example

**** Testing Winner

When there's a winner, there should be no buttons, but instead an element with the winner ref:

test/components/Voting_spec.jsx
it('renders just the winner when there is one', () => {
  const component = renderIntoDocument(
    <Voting winner="Trainspotting" />
  );
  const buttons = scryRenderedDOMComponentsWithTag(component, 'button');
  expect(buttons.length).to.equal(0);

  const winner = React.findDOMNode(component.refs.winner);
  expect(winner).to.be.ok;
  expect(winner.textContent).to.contain('Trainspotting');
});

We could also have written unit tests for each component separately, but I find it more appropriate in
this case to treat the Voting screen as the "unit" to test. We test the component's external behavior,
and the fact that it uses smaller components internally is an implementation detail. 

** DONE Immutable Data And Pure Rendering 
   CLOCK: [2015-11-27 Fri 06:37]--[2015-11-27 Fri 06:47] =>  0:10
   :PROPERTIES:
   :Effort:   0:05
   :END:
*** Introduction
We have discussed the virtues of using immutable data, but there's one additional, very practical
benefit that we get when using it together with React: If we only use immutable data in component
props, and write the component as a pure component, we can have React use a more efficient strategy
for detecting changes in the props.

*** Testing PureRenderMixin
    CLOCK: [2015-11-27 Fri 06:59]--[2015-11-27 Fri 07:27] =>  0:28
    CLOCK: [2015-11-27 Fri 06:48]--[2015-11-27 Fri 06:58] =>  0:10
    :PROPERTIES:
    :Effort:   0:15
    :END:
    
**** Introduction
This is done by applying the PureRenderMixin that is available as an add-on package. When this mixin
is added to a component, it changes the way React checks for changes in the component's props (and
state). Instead of a deep compare it does a shallow compare, which is much, much faster.

The reason we can do this is that by definition, there can never be changes within immutable data
structures. If the props of a component are all immutable values, and the props keep pointing to the
same values between renders, there can be no reason to re-render the component, and it can be skipped
completely!

**** Test for mutable data

We can concretely see what this is about by writing some unit tests. Our component is supposed to be
pure, so if we did give it a mutable array, and then caused a mutation inside the array, it should not
be re-rendered:

test/components/Voting_spec.jsx
it('renders as a pure component', () => {
  const pair = ['Trainspotting', '28 Days Later'];
  const component = renderIntoDocument(
    <Voting pair={pair} />
  );

  let firstButton = scryRenderedDOMComponentsWithTag(component, 'button')[0];
  expect(firstButton.textContent).to.equal('Trainspotting');

  pair[0] = 'Sunshine';
  component.setProps({pair: pair});
  firstButton = scryRenderedDOMComponentsWithTag(component, 'button')[0];
  expect(firstButton.textContent).to.equal('Trainspotting');
});
#+BEGIN_SRC sh :results verbatim
npm run test
#+END_SRC

#+RESULTS:

**** test case for immutable data pair
We should have to explicitly set a new immutable list in the props to have the change reflected in the
UI:

test/components/Voting_spec.jsx
import React from 'react/addons';
import {List} from 'immutable';
import Voting from '../../src/components/Voting';
import {expect} from 'chai';

const {renderIntoDocument, scryRenderedDOMComponentsWithTag, Simulate}
  = React.addons.TestUtils;

describe('Voting', () => {

  // ...

  it('does update DOM when prop changes', () => {
    const pair = List.of('Trainspotting', '28 Days Later');
    const component = renderIntoDocument(
      <Voting pair={pair} />
    );

    let firstButton = scryRenderedDOMComponentsWithTag(component, 'button')[0];
    expect(firstButton.textContent).to.equal('Trainspotting');

    const newPair = pair.set(0, 'Sunshine');
    component.setProps({pair: newPair});
    firstButton = scryRenderedDOMComponentsWithTag(component, 'button')[0];
    expect(firstButton.textContent).to.equal('Sunshine');
  });

});

I wouldn't usually bother writing tests like this one, and would just assume that PureRenderMixin is
being used. In this case the tests just happen to help us understand what exactly is going on. 

Running the tests at this point will show how the component is not currently behaving as we expect:
It'll update the UI in both cases, which means it is doing deep checks within the props, 
which is what we wanted to avoid since we're going to be using immutable data.

#+BEGIN_SRC sh :results verbatim
npm run test
#+END_SRC

#+RESULTS:

**** PureRenderMixin in React addons
Everything falls into place when we enable the pure render mixin in our components. We need to install
its package first:
#+BEGIN_SRC sh
npm install --save react-addons-pure-render-mixin
#+END_SRC

#+RESULTS:
: react-addons-pure-render-mixin@0.14.3 node_modules/react-addons-pure-render-mixin


If we now mix it into our components, tests start passing and we're done:

src/components/Voting.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';
import Winner from './Winner';
import Vote from './Vote';

export default React.createClass({
  mixins: [PureRenderMixin],
  // ...
});
src/components/Vote.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';

export default React.createClass({
  mixins: [PureRenderMixin],
  // ...
});
src/components/Winner.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';

export default React.createClass({
  mixins: [PureRenderMixin],
  // ...
});

Strictly speaking, the tests would start to pass if we only enabled the pure render mixin for Voting
and didn't bother with the two other components. That's because when React doesn't notice any changes
in the Voting props, it skips re-rendering for the whole component subtree. 

However, I find it more appropriate to consistently use the pure render mixin in all my components,
both to make it explicit that the components are pure, and to make sure they will behave as I expect
even after I rearrange them. 
#+BEGIN_SRC sh :results verbatim
npm run test 
#+END_SRC

#+RESULTS:
#+begin_example

> voting-client@1.0.0 test /usr/local/src/jstutorials/voting-client
> mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'



  Voting
    ✓ renders a poir of buttons
    ✓ invokes callback when a button is clicked
    ✓ disable buttons when user has voted
    ✓ adds label to the voted entry
    ✓ renders just the winner when there is one
    ✓ renders as a pure component
    ✓ does update DOM when prop changes (54ms)


  7 passing (209ms)

#+end_example

** DONE Writing The UI for The Results Screen And Handling Routing 
   CLOCK: [2015-11-27 Fri 07:48]--[2015-11-27 Fri 08:22] =>  0:34
   CLOCK: [2015-11-27 Fri 07:31]--[2015-11-27 Fri 07:34] =>  0:03
   :PROPERTIES:
   :Effort:   0:06
   :END:
*** Voting Screen
With that Voting screen all done, let's move on to the other main screen of the app: The one where
results will be shown.
The data displayed here is the same pair of entries as in the voting screen, and the tally of votes
for each. Additionally, there's a little button on the bottom with which the person managing the vote
can move on to the next pair.
*** Result Screen
What we have here are two separate screens, exactly one of which should be shown at any given time. To
choose between the two, using URL paths might be a good idea: We could set the root path #/ to show
the voting screen, and a #/results path to show the results screen.
*** Router 
    CLOCK: [2015-11-27 Fri 08:24]--[2015-11-27 Fri 08:42] =>  0:18
    :PROPERTIES:
    :Effort:   0:13
    :END:

**** DONE Install
     That kind of thing can easily be done with the react-router library, with which we can associate
different components to different paths. Let's add it to the project:
#+BEGIN_SRC sh
npm install --save react-router@1.0.0-rc3
#+END_SRC

#+RESULTS:
**** TEST Adding Voting route 
We can now configure our route paths. The Router comes with a React component called Route, which can
be used to declaratively define a routing table. For now, we'll have just one route:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import {Route} from 'react-router';
import App from './components/App';
import Voting from './components/Voting';

const pair = ['Trainspotting', '28 Days Later'];

const routes = <Route component={App}>
  <Route path="/" component={Voting} />
</Route>;

ReactDOM.render(
  <Voting pair={pair} />,
  document.getElementById('app')
);

   

We have a single route that we have configured to point to the Voting component. The other thing we've
done here is define a component for the root Route in the configuration, which will be shared for all
the concrete routes within. It's pointing to an App component, which we'll soon create.

**** TEST Root Component  
The purpose of the root route component is to render all the markup that is common across all routes.
Here's what our root component App should look like:

src/components/App.jsx
import React from 'react';
import {List} from 'immutable';

const pair = List.of('Trainspotting', '28 Days Later');

export default React.createClass({
  render: function() {
    return React.cloneElement(this.props.children, {pair: pair});
  }
});

   

This component does nothing except render its child components, expected to be given in as the
children prop. This is something that the react-router package does for us. It plugs in the component
(s) defined for whatever the current route happens to be. Since we currently just have the one route
for Voting, at the moment this component always renders Voting.
**** TEST CloneElement API
Notice that we've moved the placeholder pair data from index.jsx to App.jsx. We use React's
cloneElement API to create a clone of the original components with our custom pair prop attached. This
is just a temporary measure, and we'll be able to remove the cloning call later. 

Earlier we discussed how *it's generally a good idea to use the pure render mixin across all*
*components. The App component is an exception to this rule.* The reason is that it would cause route
changes not to fire, because of an implementation issue between the router and React itself. This
situation may well change in the near future.
**** TEST Kickstart the Router
We can now switch back to index.js where we can kickstart the Router itself, and have it initialize
our application:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Router, {Route} from 'react-router';
import App from './components/App';
import Voting from './components/Voting';

const routes = <Route component={App}>
  <Route path="/" component={Voting} />
</Route>;

ReactDOM.render(
  <Router>{routes}</Router>,
  document.getElementById('app')
);

We now supply the Router component from the react-router package as the root component of our
application. We plug our route table into it by passing it in as a child component.


With this, we've restored the previous functionality of our app: It just renders the Voting component.
But this time it is done with the React router baked in, which means we can now easily add more
routes.
*** Implemantation of results screen
***** TEST Initilization
      CLOCK: [2015-11-27 Fri 08:42]--[2015-11-27 Fri 08:46] =>  0:04
      :PROPERTIES:
      :Effort:   0:15
      :END:
This will be served by a new component called Results:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Router, {Route} from 'react-router';
import App from './components/App';
import Voting from './components/Voting';
import Results from './components/Results';

const routes = <Route component={App}>
  <Route path="/results" component={Results} />
  <Route path="/" component={Voting} />
</Route>;

ReactDOM.render(
  <Router>{routes}</Router>,
  document.getElementById('app')
);

Here we use the <Route> component again to specify that for a path named "/results", the Results
component should be used. Everything else will still be handled by Voting.
***** TEST Simple implementation of Results
      CLOCK: [2015-11-27 Fri 09:12]--[2015-11-27 Fri 09:19] =>  0:07
      :PROPERTIES:
      :Effort:   0:02
      :ORDERED:  t
      :END:

Let's make a simple implementation of Results so that we can see how the routing works:

src/components/Results.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';

export default React.createClass({
  mixins: [PureRenderMixin],
  render: function() {
    return <div>Hello from results!</div>
  }
});

If you now point your browser to http://localhost:8080/#/results, you should see the little message
from the Results component. The root path, on the other hand, should show the voting buttons. You can
also use the back and forward buttons to switch between the routes, and the visible component is
switched while the application remains alive. That's the router in action!

This is all we're going to do with the React Router in this application. The library is capable of a
lot more though. Take a look at its documentation to find out about all the things you can do with it.
***** TEST Implemantation of Results component
      CLOCK: [2015-11-27 Fri 09:21]--[2015-11-27 Fri 09:26] =>  0:05
      :PROPERTIES:
      :Effort:   0:05
      :END:

Now that we have a placeholder Results component, let's go right ahead and make it do something
useful. It should display the same two entries currently being voted on that the Voting component
does:

src/components/Results.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';

export default React.createClass({
  mixins: [PureRenderMixin],
  getPair: function() {
    return this.props.pair || [];
  },
  render: function() {
    return <div className="results">
      {this.getPair().map(entry =>
        <div key={entry} className="entry">
          <h1>{entry}</h1>
        </div>
      )}
    </div>;
  }
  });
***** TEST Add Tally
      CLOCK: [2015-11-26 Thu 09:30]--[2015-11-26 Thu 11:30] =>  2:00
      :PROPERTIES:
      :Effort:   0:15
      :END:      

Since this is the results screen, it should also actually show the tally of votes. That's what people
want to see when they're on this screen. Let's pass in a placeholder tally Map to the component from
our root App component first:

src/components/App.jsx
import React from 'react';
import {List, Map} from 'immutable';

const pair = List.of('Trainspotting', '28 Days Later');
const tally = Map({'Trainspotting': 5, '28 Days Later': 4});

export default React.createClass({
  render: function() {
    return React.cloneElement(this.props.children, {
      pair: pair,
      tally: tally
    });
  }
});

Now we can tweak the Results component to show those numbers:

src/components/Results.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';

export default React.createClass({
  mixins: [PureRenderMixin],
  getPair: function() {
    return this.props.pair || [];
  },
  getVotes: function(entry) {
    if (this.props.tally && this.props.tally.has(entry)) {
      return this.props.tally.get(entry);
    }
    return 0;
  },
  render: function() {
    return <div className="results">
      {this.getPair().map(entry =>
        <div key={entry} className="entry">
          <h1>{entry}</h1>
          <div className="voteCount">
            {this.getVotes(entry)}
          </div>
        </div>
      )}
    </div>;
  }
});

At this point, let's switch gears and add a unit test for the current behavior of the Results
component to make sure we won't break it later.
**** UNIT Testing for Voting Result
We expect the component to render a div for each entry, and display both the entry name and the number
of votes within that div. For entries that have no votes, a vote count of zero should be shown:

test/components/Results_spec.jsx
import React from 'react/addons';
import {List, Map} from 'immutable';
import Results from '../../src/components/Results';
import {expect} from 'chai';

const {renderIntoDocument, scryRenderedDOMComponentsWithClass}
  = React.addons.TestUtils;

describe('Results', () => {

  it('renders entries with vote counts or zero', () => {
    const pair = List.of('Trainspotting', '28 Days Later');
    const tally = Map({'Trainspotting': 5});
    const component = renderIntoDocument(
      <Results pair={pair} tally={tally} />
    );
    const entries = scryRenderedDOMComponentsWithClass(component, 'entry');
    const [train, days] = entries.map(e => e.textContent);

    expect(entries.length).to.equal(2);
    expect(train).to.contain('Trainspotting');
    expect(train).to.contain('5');
    expect(days).to.contain('28 Days Later');
    expect(days).to.contain('0');
  });

});

**** Next button of the Result
***** Test case 
Next, let's talk about the "Next" button, which is used to move the voting to the next entry.

From the component's point of view, there should just be a callback function in the props. The
component should invoke that callback when the "Next" button inside it is clicked. We can formulate a
unit test for this, which is quite similar to the ones we made for the voting buttons:

test/components/Results_spec.jsx
import React from 'react/addons';
import {List, Map} from 'immutable';
import Results from '../../src/components/Results';
import {expect} from 'chai';

const {renderIntoDocument, scryRenderedDOMComponentsWithClass, Simulate}
  = React.addons.TestUtils;

describe('Results', () => {

  // ...

  it('invokes the next callback when next button is clicked', () => {
    let nextInvoked = false;
    const next = () => nextInvoked = true;

    const pair = List.of('Trainspotting', '28 Days Later');
    const component = renderIntoDocument(
      <Results pair={pair}
               tally={Map()}
               next={next}/>
    );
    Simulate.click(React.findDOMNode(component.refs.next));

    expect(nextInvoked).to.equal(true);
  });

});
***** Implemantation
The implementation is also similar to the voting buttons. It is just slightly simpler, as there are no
arguments to pass:

src/components/Results.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';

export default React.createClass({
  mixins: [PureRenderMixin],
  getPair: function() {
    return this.props.pair || [];
  },
  getVotes: function(entry) {
    if (this.props.tally && this.props.tally.has(entry)) {
      return this.props.tally.get(entry);
    }
    return 0;
  },
  render: function() {
    return <div className="results">
      <div className="tally">
        {this.getPair().map(entry =>
          <div key={entry} className="entry">
            <h1>{entry}</h1>
            <div class="voteCount">
              {this.getVotes(entry)}
            </div>
          </div>
        )}
      </div>
      <div className="management">
        <button ref="next"
                className="next"
                onClick={this.props.next}>
          Next
        </button>
      </div>
    </div>;
  }
});
**** Winner screen in result 
***** Unit Test 
Finally, just like the Voting screen, the Results screen should display the winner once we have one:

test/components/Results_spec.jsx
it('renders the winner when there is one', () => {
  const component = renderIntoDocument(
    <Results winner="Trainspotting"
             pair={["Trainspotting", "28 Days Later"]}
             tally={Map()} />
  );
  const winner = React.findDOMNode(component.refs.winner);
  expect(winner).to.be.ok;
  expect(winner.textContent).to.contain('Trainspotting');
});
***** Source 
We can implement this by simply reusing the Winner component we already developed for the Voting
screen. If there's a winner, we render it instead of the regular Results screen:

src/components/Results.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';
import Winner from './Winner';

export default React.createClass({
  mixins: [PureRenderMixin],
  getPair: function() {
    return this.props.pair || [];
  },
  getVotes: function(entry) {
    if (this.props.tally && this.props.tally.has(entry)) {
      return this.props.tally.get(entry);
    }
    return 0;
  },
  render: function() {
    return this.props.winner ?
      <Winner ref="winner" winner={this.props.winner} /> :
      <div className="results">
        <div className="tally">
          {this.getPair().map(entry =>
            <div key={entry} className="entry">
              <h1>{entry}</h1>
              <div className="voteCount">
                {this.getVotes(entry)}
              </div>
            </div>
          )}
        </div>
        <div className="management">
          <button ref="next"
                   className="next"
                   onClick={this.props.next}>
            Next
          </button>
        </div>
      </div>;
  }
});

This component would also benefit from being broken down into smaller ones. Perhaps a Tally component
for displaying the pair of entries. Go ahead and do the refactoring if you feel like it! 

And that's pretty much what our simple application will need in terms of UI! The components we've
written don't yet do anything because they're not connected to any real data or actions. It is
remarkable, however, just how far we're able to get without needing any of that. We have been able to
just inject some simple placeholder data to these components and concentrate on the structure of the
UI.

Now that we do have the UI though, let's talk about how to make it come alive by connecting its inputs
and outputs to a Redux store.

** DONE Introducing A Client-Side Redux Store 
   CLOCK: [2015-11-27 Fri 12:58]--[2015-11-27 Fri 13:35] =>  0:37
*** DONE Introduction
Redux is really designed to be used as the state container for UI applications, exactly like the one
we are in the process of building. We've only used Redux on the server so far though, and discovered
it's actually pretty useful there too! Now we're ready to look at how Redux works with a React
application, which is arguably where it's most commonly used.

Just like on the server, we'll begin by thinking about the state of the application. That state is
going to be quite similar to the one on the server, which is not by accident.

We have a UI with two screens. On both of them we display the pair of entries that's being voted on.
It would make sense to have a state which included a vote entry with such a pair:

In addition to this, the results screen displays the current tally of votes. That should also be in
the vote state:

*** DONE State
**** Voted
The Voting component renders differently when the user has already voted in the current pair. This is
something that the state also needs to track:

**** Winner 

When there is a winner, we need that and only that in the state:

**** hasVoted client side state  

Notice that everything in here is a subset of the server state, except for the hasVoted entry.

*** DONE Implemantation Details 
This brings us to the implementation of the core logic and the actions and reducers that our Redux
Store will use. What should they be?

**** DONE User Actions
We can think about this in terms of what can happen while the application is running that could cause
the state to change. One source of state changes are the user's actions. We currently have two
possible user interactions built into the UI:

***** The user clicks one of the vote buttons on the voting screen. 
***** The user click on the Next button on the results screen. 
***** Server send us it's current state
Additionally, we know that our server is set up to send us its current state. We will soon be writing
the code for receiving it. That is a third source of state change.
****** Merge the server state
We can begin with the server state update, since that is going to be the most straightforward one to
do. Earlier we set the server up to emit a state event, whose payload is almost exactly the shape of
the client-side state trees that we have drawn. This is no coincidence since that's how we designed
it. From the point of view of our client's reducer, it would make sense to have an action that
receives the state snapshot from the server and just merges it into the client state. The action would
look something like this:

{
  type: 'SET_STATE',
  state: {
    vote: {...}
  }
}
**** DONE  implemantioan Redux to client
***** DONE Test SET_STATE
      CLOCK: [2015-11-27 Fri 13:37]--[2015-11-27 Fri 13:46] =>  0:09

Let's add some unit tests to see how this might work out. We're expecting to have a reducer that,
given an action like the one above, merges its payload into the current state:

test/reducer_spec.js
import {List, Map, fromJS} from 'immutable';
import {expect} from 'chai';

import reducer from '../src/reducer';

describe('reducer', () => {

  it('handles SET_STATE', () => {
    const initialState = Map();
    const action = {
      type: 'SET_STATE',
      state: Map({
        vote: Map({
          pair: List.of('Trainspotting', '28 Days Later'),
          tally: Map({Trainspotting: 1})
        })
      })
    };
    const nextState = reducer(initialState, action);

    expect(nextState).to.equal(fromJS({
      vote: {
        pair: ['Trainspotting', '28 Days Later'],
        tally: {Trainspotting: 1}
      }
    }));
  });

});

***** DONE immutable data structure by the time it is returned as the next value:
      CLOCK: [2015-11-27 Fri 13:47]--[2015-11-27 Fri 13:52] =>  0:05
      :PROPERTIES:
      :Effort:   8
      :ORDERED:  t
      :END:

The reducers should be able to receive plain JavaScript data structure, as opposed to an Immutable
data structure, since that's what actually get from the socket. It should still be turned into an
immutable data structure by the time it is returned as the next value:

test/reducer_spec.js
it('handles SET_STATE with plain JS payload', () => {
  const initialState = Map();
  const action = {
    type: 'SET_STATE',
    state: {
      vote: {
        pair: ['Trainspotting', '28 Days Later'],
        tally: {Trainspotting: 1}
      }
    }
  };
  const nextState = reducer(initialState, action);

  expect(nextState).to.equal(fromJS({
    vote: {
      pair: ['Trainspotting', '28 Days Later'],
      tally: {Trainspotting: 1}
    }
  }));
});
#+BEGIN_SRC sh :results verbatim
npm run test
#+END_SRC

#+RESULTS:
#+begin_example

> voting-client@1.0.0 test /usr/local/src/jstutorials/voting-client
> mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'



  Results
    ✓ renders entries with vote counts or zero (38ms)
    ✓ invokes the next callback when next button is clicked
    ✓ renders the winner when there is one

  Voting
    ✓ renders a poir of buttons
    ✓ invokes callback when a button is clicked
    ✓ disable buttons when user has voted
    ✓ adds label to the voted entry
    ✓ renders just the winner when there is one
    ✓ renders as a pure component
    ✓ does update DOM when prop changes

  reducer
    ✓ handles SET_STATE
    ✓ handles SET_STATE with plain JS payload

  12 passing (214ms)

#+end_example

***** DONE Handle undifined initial state
As part of the reducer contract, an undefined initial state should also be correctly initialized into
an Immutable data structure by the reducer:

test/reducer_spec.js
it('handles SET_STATE without initial state', () => {
  const action = {
    type: 'SET_STATE',
    state: {
      vote: {
        pair: ['Trainspotting', '28 Days Later'],
        tally: {Trainspotting: 1}
      }
    }
  };
  const nextState = reducer(undefined, action);

  expect(nextState).to.equal(fromJS({
    vote: {
      pair: ['Trainspotting', '28 Days Later'],
      tally: {Trainspotting: 1}
    }
  }));
});
#+BEGIN_SRC sh :results verbatim
npm run test
#+END_SRC

#+RESULTS:
#+begin_example

> voting-client@1.0.0 test /usr/local/src/jstutorials/voting-client
> mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'



  Results
    ✓ renders entries with vote counts or zero (43ms)
    ✓ invokes the next callback when next button is clicked
    ✓ renders the winner when there is one

  Voting
    ✓ renders a poir of buttons
    ✓ invokes callback when a button is clicked
    ✓ disable buttons when user has voted
    ✓ adds label to the voted entry
    ✓ renders just the winner when there is one
    ✓ renders as a pure component
    ✓ does update DOM when prop changes

  reducer
    ✓ handles SET_STATE
    ✓ handles SET_STATE with plain JS payload
    ✓ handles SET_STATE without initial state


  13 passing (186ms)

#+end_example

***** DONE Implemanting client side Reducer
That's our spec. Let's see how to fulfill it. We should have a reducer function exported by the
reducer module:

src/reducer.js
import {Map} from 'immutable';

export default function(state = Map(), action) {

  return state;
}
***** DONE SET_STATE
The reducer should handle the SET_STATE action. In its handler function we can actually just merge the
given new state to the old state, using the merge function from Map. That makes our tests pass!

src/reducer.js
import {Map} from 'immutable';

function setState(state, newState) {
  return state.merge(newState);
}

export default function(state = Map(), action) {
  switch (action.type) {
  case 'SET_STATE':
    return setState(state, action.state);
  }
  return state;
}

Notice that here we are not bothering with a "core" module separated from the reducer module. That's
because the logic in our reducer is so simple that it doesn't really warrant one. We're just doing a
merge, whereas on the server we have our whole voting system's logic in there. It might later be more
appropriate to add some separation of concerns in the client as well, if the need arises. 

The two remaining causes for state change are the user actions: Voting and clicking "Next". Since
these are both actions that involve server interaction, we'll return to them a bit later, after we've
got the architecture for server communication in place.
#+BEGIN_SRC sh :results verbatim 
npm run test
#+END_SRC

#+RESULTS:
#+begin_example

> voting-client@1.0.0 test /usr/local/src/jstutorials/voting-client
> mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'



  Results
    ✓ renders entries with vote counts or zero (39ms)
    ✓ invokes the next callback when next button is clicked
    ✓ renders the winner when there is one

  Voting
    ✓ renders a poir of buttons
    ✓ invokes callback when a button is clicked
    ✓ disable buttons when user has voted
    ✓ adds label to the voted entry
    ✓ renders just the winner when there is one
    ✓ renders as a pure component
    ✓ does update DOM when prop changes

  reducer
    ✓ handles SET_STATE


  11 passing (158ms)

#+end_example

***** DONE Installation 
Now that we have a reducer though, we can spin up a Redux Store from it. Time to add Redux to the
project:
#+BEGIN_SRC sh
npm install --save redux
#+END_SRC

#+RESULTS:
: redux@3.0.4 node_modules/redux

***** DONE Initialization 
      CLOCK: [2015-11-27 Fri 14:06]--[2015-11-27 Fri 14:11] =>  0:05

The entry point index.jsx is a good place to set up the Store. Let's also kick it off with some state
by dispatching the SET_STATE action on it (this is only temporary until we get real data in):

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Router, {Route} from 'react-router';
import {createStore} from 'redux';
import reducer from './reducer';
import App from './components/App';
import Voting from './components/Voting';
import Results from './components/Results';

const store = createStore(reducer);
store.dispatch({
  type: 'SET_STATE',
  state: {
    vote: {
      pair: ['Sunshine', '28 Days Later'],
      tally: {Sunshine: 2}
    }
  }
});

const routes = <Route component={App}>
  <Route path="/results" component={Results} />
  <Route path="/" component={Voting} />
</Route>;

ReactDOM.render(
  <Router>{routes}</Router>,
  document.getElementById('app')
);

There's our Store. Now, how do we get the data from the Store into the React components?

** DONE Getting Data In from Redux to React 
*** Introduction
We have a Redux Store that holds our immutable application state. We have stateless React components
that take immutable data as inputs. The two would be a great fit: If we can figure out a way to always
get the latest data from the Store to the components, that would be perfect. React would re-render
when the state changes, and the pure render mixin would make sure that the parts of the UI that have
no need to re-render won't be.
*** Init
Rather than writing such synchronization code ourselves, we can make use of the Redux React bindings
that are available in the react-redux package:
#+BEGIN_SRC sh 
npm install --save react-redux
#+END_SRC

#+RESULTS:
| react-redux@4.0.0 | node_modules/react-redux      |                      |
| ├──               | hoist-non-react-statics@1.0.3 |                      |
| └──               | invariant@2.2.0               | (loose-envify@1.1.0) |


The big idea of react-redux is to take our pure components and wire them up into a Redux Store by
doing two things:

**** Mapping the Store state into component input props. 
**** Mapping actions into component output callback props. 
*** react-redux provider
    CLOCK: [2015-11-27 Fri 22:54]--[2015-11-27 Fri 23:44] =>  0:50
    CLOCK: [2015-11-27 Fri 21:58]--[2015-11-27 Fri 22:25] =>  0:27
    :PROPERTIES:
    :Effort:   15
    :END:
**** DONE Init
Before any of this is possible, we need to wrap our top-level application component inside a
react-redux Provider component. This connects our component tree to a Redux store, enabling us to make
the mappings for individual components later.

We'll put in the Provider around the Router component. That'll cause the Provider to be an ancestor to
all of our application components:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Router, {Route} from 'react-router';
import {createStore} from 'redux';
import {Provider} from 'react-redux';
import reducer from './reducer';
import App from './components/App';
import {VotingContainer} from './components/Voting';
import Results from './components/Results';

const store = createStore(reducer);
store.dispatch({
  type: 'SET_STATE',
  state: {
    vote: {
      pair: ['Sunshine', '28 Days Later'],
      tally: {Sunshine: 2}
    }
  }
});

const routes = <Route component={App}>
  <Route path="/results" component={Results} />
  <Route path="/" component={VotingContainer} />
</Route>;

ReactDOM.render(
  <Provider store={store}>
    <Router>{routes}</Router>
  </Provider>,
  document.getElementById('app')
);

});

   

Next, we should think about which of our components need to be "wired up" so that all the data will
come from the Store. We have five component, which we can divide in three categories:

**** DONE The root component App doesn't really need anything since it doesn't use any data. 
**** Vote and Winner are only used by parent components that give them all the props they need. 
They don't need wiring up either. 
**** What's left are the components we use in routes: Voting and Results. 
     They are currently getting data
     in as hardcoded placeholder props from App. These are the components that need to be wired up to the
     Store. 

     Let's begin with the Voting component. With react-redux we get a function called connect that can do
     the wiring-up of a component. It takes a mapping function as an argument and returns another function
     that takes a React component class:

     connect(mapStateToProps)(SomeComponent);
**** TEST Connect Voting Containter to store
     The role of the mapping function is to map the state from the Redux Store into an object of props.
     Those props will then be merged into the props of the component that's being connected. In the case of
     Voting, we just need to map the pair and winner from the state:

src/components/Voting.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin'
import {connect} from 'react-redux';
import Winner from './Winner';
import Vote from './Vote';

const Voting = React.createClass({
  mixins: [PureRenderMixin],
  render: function() {
    return <div>
      {this.props.winner ?
        <Winner ref="winner" winner={this.props.winner} /> :
        <Vote {...this.props} />}
    </div>;
  }
});

function mapStateToProps(state) {
  return {
    pair: state.getIn(['vote', 'pair']),
    winner: state.get('winner')
  };
}

connect(mapStateToProps)(Voting);

export default Voting;
**** TEST Export the VotingContainer
This isn't quite right though. True to functional style, the connect function doesn't actually go and
mutate the Voting component. Voting remains a pure, unconnected component. Instead, connect returns a
connected version of Voting. That means our current code isn't really doing anything. We need to grab
that return value, which we'll call VotingContainer:

src/components/Voting.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';
import {connect} from 'react-redux';
import Winner from './Winner';
import Vote from './Vote';

export const Voting = React.createClass({
  mixins: [PureRenderMixin],
  render: function() {
    return <div>
      {this.props.winner ?
        <Winner ref="winner" winner={this.props.winner} /> :
        <Vote {...this.props} />}
    </div>;
  }
});

function mapStateToProps(state) {
  return {
    pair: state.getIn(['vote', 'pair']),
    winner: state.get('winner')
  };
}

export const VotingContainer = connect(mapStateToProps)(Voting);

The module now exports two components: The pure component Voting and the connected component
VotingContainer. The react-redux documentation calls the former a "dumb" component and the latter a
"smart" component. I prefer "pure" and "connected". Call them what you will, understanding the
difference is key:

**** The pure/dumb component is fully driven by the props it is given.
     :PROPERTIES:
     :ORDERED:  t
     :END:
    It is the component equivalent of a pure function. 
**** TODAY The connected/smart component.
    on the other hand, wraps the pure version with some logic that will
    keep it in sync with the changing state of the Redux Store. That logic is provided by react-redux. 
**** TEST Update Routing table 
We should update our routing table, so that it uses VotingContainer instead of Voting. Once we've done
that, the voting screen will come alive with the data we've put in the Redux store:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Router, {Route} from 'react-router';
import {createStore} from 'redux';
import {Provider} from 'react-redux';
import reducer from './reducer';
import App from './components/App';
import {VotingContainer} from './components/Voting';
import Results from './components/Results';

const store = createStore(reducer);
store.dispatch({
  type: 'SET_STATE',
  state: {
    vote: {
      pair: ['Sunshine', '28 Days Later'],
      tally: {Sunshine: 2}
    }
  }
});

const routes = <Route component={App}>
  <Route path="/results" component={Results} />
  <Route path="/" component={VotingContainer} />
</Route>;

ReactDOM.render(
  <Provider store={store}>
    <Router>{routes}</Router>
  </Provider>,
  document.getElementById('app')
);


   
**** DONE Unit tests
In the unit tests for Voting we need to change the way the import is done, as we no longer have Voting
as the default export:

test/components/Voting_spec.jsx
import React from 'react/addons';
import {List} from 'immutable';
import {Voting} from '../../src/components/Voting';
import {expect} from 'chai';

No other changes are needed for tests. They are written for the pure Voting component, and it isn't
changed in any way. We've just added a wrapper for it that connects it to a Redux store.

Now we should just apply the same trick for the Results screen. It also needs the pair and winner
attributes of the state. Additionally it needs tally, in order to show the vote counts:
#+BEGIN_SRC sh :results verbatim
npm run test
#+END_SRC

#+RESULTS:
#+begin_example

> voting-client@1.0.0 test /usr/local/src/jstutorials/voting-client
> mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'



  Results
    ✓ renders entries with vote counts or zero (44ms)
    ✓ invokes the next callback when next button is clicked
    ✓ renders the winner when there is one

  Voting
    ✓ renders a poir of buttons
    ✓ invokes callback when a button is clicked
    ✓ disable buttons when user has voted
    ✓ adds label to the voted entry
    ✓ renders just the winner when there is one
    ✓ renders as a pure component
    ✓ does update DOM when prop changes

  reducer
    ✓ handles SET_STATE


  11 passing (286ms)

#+end_example

**** TEST Connect Result componant 
src/components/Results.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';
import {connect} from 'react-redux';
import Winner from './Winner';

export const Results = React.createClass({
  mixins: [PureRenderMixin],
  getPair: function() {
    return this.props.pair || [];
  },
  getVotes: function(entry) {
    if (this.props.tally && this.props.tally.has(entry)) {
      return this.props.tally.get(entry);
    }
    return 0;
  },
  render: function() {
    return this.props.winner ?
      <Winner ref="winner" winner={this.props.winner} /> :
      <div className="results">
        <div className="tally">
          {this.getPair().map(entry =>
            <div key={entry} className="entry">
              <h1>{entry}</h1>
              <div className="voteCount">
                {this.getVotes(entry)}
              </div>
            </div>
          )}
        </div>
        <div className="management">
          <button ref="next"
                   className="next"
                   onClick={this.props.next}>
            Next
          </button>
      </div>
      </div>;
  }
});

function mapStateToProps(state) {
  return {
    pair: state.getIn(['vote', 'pair']),
    tally: state.getIn(['vote', 'tally']),
    winner: state.get('winner')
  }
}

export const ResultsContainer = connect(mapStateToProps)(Results);
**** TEST Init ResultsContainer
In index.jsx we should change the results route to then use ResultsContainer instead of Results:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Router, {Route} from 'react-router';
import {createStore} from 'redux';
import {Provider} from 'react-redux';
import reducer from './reducer';
import App from './components/App';
import {VotingContainer} from './components/Voting';
import {ResultsContainer} from './components/Results';

const store = createStore(reducer);
store.dispatch({
  type: 'SET_STATE',
  state: {
    vote: {
      pair: ['Sunshine', '28 Days Later'],
      tally: {Sunshine: 2}
    }
  }
});

const routes = <Route component={App}>
  <Route path="/results" component={ResultsContainer} />
  <Route path="/" component={VotingContainer} />
</Route>;

ReactDOM.render(
  <Provider store={store}>
    <Router>{routes}</Router>
  </Provider>,
  document.getElementById('app')
);

**** TEST Unit testing Result Container   

Finally, in the Results test we should update the import statement to use the named export for
Results:

test/components/Results_spec.jsx
import React from 'react/addons';
import {List, Map} from 'immutable';
import {Results} from '../../src/components/Results';
import {expect} from 'chai';

**** TODAY talks 
And that's how you can connect pure React components to a Redux store, so that they get their data in
from the store.

For very small apps that just have a single root component and no routing, connecting the root
component will be enough in most cases. The root can then just propagate the data to its children as
props. For apps with routing, such as the one we're making, connecting each of the router's components
is usually a good idea. But any component can be separately connected, so different strategies can be
used for different app architectures. I think it's a good idea to use plain props whenever you can,
because with props it is easy to see what data is going in and it is also less work since you don't
need to manage the "wiring" code.
**** TEST Removing Hardcoded Props
Now that we've got the Redux data in our UI, we no longer need the hardcoded props in App.jsx, so it
becomes even simpler than before:

src/components/App.jsx
import React from 'react';

export default React.createClass({
  render: function() {
    return this.props.children;
  }
});

   
  
** DONE Setting Up The Socket.io Client 
   CLOCK: [2015-11-28 Sat 00:34]--[2015-11-28 Sat 00:53] =>  0:19
   :PROPERTIES:
   :Effort:   0:12
   :END:

Now that we have a Redux app going in the client, we can talk about how we can connect it to the other
Redux app we have running on the server. The two currently reside in their own universes, with no
connection between them whatsoever.

The server is already prepared to take incoming socket connections and emit the voting state to them.
The client, on the other hand, has a Redux store into which we could easily dispatch incoming data.
All we need to do is to draw the connection.

This begins by getting the infrastructure in place. We need a way to make a Socket.io connection from
the browser to the server. For that purpose we can use the socket.io-client library, which is the
client-side equivalent to the socket.io library that we used on the server:
#+BEGIN_SRC sh
npm install --save socket.io-client
#+END_SRC

#+RESULTS:
|                        |                                                |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| >                      | bufferutil@1.2.1                               | install                   | /usr/local/src/jstutorials/voting-client/node_modules/socket.io-client/node_modules/engine.io-client/node_modules/ws/node_modules/bufferutil             |              |                  |                |                 |                         |                 |           |
| >                      | node-gyp                                       | rebuild                   |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
|                        |                                                |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| make:                  | Entering                                       | directory                 | '/usr/local/src/jstutorials/voting-client/node_modules/socket.io-client/node_modules/engine.io-client/node_modules/ws/node_modules/bufferutil/build'     |              |                  |                |                 |                         |                 |           |
| CXX(target)            | Release/obj.target/bufferutil/src/bufferutil.o |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| SOLINK_MODULE(target)  | Release/obj.target/bufferutil.node             |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| COPY                   | Release/bufferutil.node                        |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| make:                  | Leaving                                        | directory                 | '/usr/local/src/jstutorials/voting-client/node_modules/socket.io-client/node_modules/engine.io-client/node_modules/ws/node_modules/bufferutil/build'     |              |                  |                |                 |                         |                 |           |
|                        |                                                |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| >                      | utf-8-validate@1.2.1                           | install                   | /usr/local/src/jstutorials/voting-client/node_modules/socket.io-client/node_modules/engine.io-client/node_modules/ws/node_modules/utf-8-validate         |              |                  |                |                 |                         |                 |           |
| >                      | node-gyp                                       | rebuild                   |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
|                        |                                                |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| make:                  | Entering                                       | directory                 | '/usr/local/src/jstutorials/voting-client/node_modules/socket.io-client/node_modules/engine.io-client/node_modules/ws/node_modules/utf-8-validate/build' |              |                  |                |                 |                         |                 |           |
| CXX(target)            | Release/obj.target/validation/src/validation.o |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| SOLINK_MODULE(target)  | Release/obj.target/validation.node             |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| COPY                   | Release/validation.node                        |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| make:                  | Leaving                                        | directory                 | '/usr/local/src/jstutorials/voting-client/node_modules/socket.io-client/node_modules/engine.io-client/node_modules/ws/node_modules/utf-8-validate/build' |              |                  |                |                 |                         |                 |           |
| socket.io-client@1.3.7 | node_modules/socket.io-client                  |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| ├──                    | to-array@0.1.3                                 |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| ├──                    | indexof@0.0.1                                  |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| ├──                    | component-bind@1.0.0                           |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| ├──                    | debug@0.7.4                                    |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| ├──                    | backo2@1.0.2                                   |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| ├──                    | object-component@0.0.3                         |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| ├──                    | component-emitter@1.1.2                        |                           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| ├──                    | has-binary@0.1.6                               | (isarray@0.0.1)           |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| ├──                    | parseuri@0.0.2                                 | (better-assert@1.0.2)     |                                                                                                                                                          |              |                  |                |                 |                         |                 |           |
| ├──                    | socket.io-parser@2.2.4                         | (isarray@0.0.1,           | benchmark@1.0.0,                                                                                                                                         | json3@3.2.6) |                  |                |                 |                         |                 |           |
| └──                    | engine.io-client@1.5.4                         | (component-inherit@0.0.3, | xmlhttprequest@1.5.0,                                                                                                                                    | debug@1.0.4, | parsejson@0.0.1, | parseqs@0.0.2, | parseuri@0.0.4, | engine.io-parser@1.2.2, | has-cors@1.0.3, | ws@0.8.0) |


Importing this library gives us an io function that can be used to connect to a Socket.io server.
Let's connect to one that we assume to be on the same host as our client, in port 8090 (matching the
port we used on the server):

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Router, {Route} from 'react-router';
import {createStore} from 'redux';
import {Provider} from 'react-redux';
import io from 'socket.io-client';
import reducer from './reducer';
import App from './components/App';
import {VotingContainer} from './components/Voting';
import {ResultsContainer} from './components/Results';

const store = createStore(reducer);
store.dispatch({
  type: 'SET_STATE',
  state: {
    vote: {
      pair: ['Sunshine', '28 Days Later'],
      tally: {Sunshine: 2}
    }
  }
});

const socket = io(`${location.protocol}//${location.hostname}:8090`);

const routes = <Route component={App}>
  <Route path="/results" component={ResultsContainer} />
  <Route path="/" component={VotingContainer} />
</Route>;

ReactDOM.render(
  <Provider store={store}>
    <Router>{routes}</Router>
  </Provider>,
  document.getElementById('app')
);


   

If you now make sure you have the server running, open the client app in a browser and inspect the
network traffic, you should see it make a WebSocket connection and start transmitting Socket.io
heartbeats on it.

During development there will actually be two Socket.io connections on the page. One is ours and the
other is supporting Webpack's hot reloading. 

** DONE Receiving Actions From The Server 

Given that we now have a Socket.io connection, there's actually not much we need to do to get data in
from it. The server is sending us state events - once when we connect and then every time something
changes. We just need to listen to those events. When we get one, we can simply dispatch a SET_STATE
action to our Store. We already have a reducer that will handle it:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Router, {Route} from 'react-router';
import {createStore} from 'redux';
import {Provider} from 'react-redux';
import io from 'socket.io-client';
import reducer from './reducer';
import App from './components/App';
import {VotingContainer} from './components/Voting';
import {ResultsContainer} from './components/Results';

const store = createStore(reducer);

const socket = io(`${location.protocol}//${location.hostname}:8090`);
socket.on('state', state =>
  store.dispatch({type: 'SET_STATE', state})
);

const routes = <Route component={App}>
  <Route path="/results" component={ResultsContainer} />
  <Route path="/" component={VotingContainer} />
</Route>;

ReactDOM.render(
  <Provider store={store}>
    <Router>{routes}</Router>
  </Provider>,
  document.getElementById('app')
);


   

Note that we've removed the hardcoded SET_STATE dispatch. We no longer need it because the server will
give us the real state.

Looking at the UI - either the voting or the results one - will now show the first pair of entries, as
defined by the server. Our server and client are connected!

** TODAY Dispatching Actions From React Components 
   CLOCK: [2015-11-28 Sat 03:50]--[2015-11-28 Sat 04:11] =>  0:21
   CLOCK: [2015-11-28 Sat 03:04]--[2015-11-28 Sat 03:24] =>  0:20
   CLOCK: [2015-11-28 Sat 01:46]--[2015-11-28 Sat 02:33] =>  0:47
   :PROPERTIES:
   :Effort:   22
   :END:
*** Introduction
We know how to get data in from the Redux Store to the UI. Let's discuss how we can get actions out
from the UI.
*** TODAY Dispatching voting buttons 
**** INTRODUCTION
The best place for us to start thinking about this is the voting buttons. When we were building the
UI, we assumed that the Voting component will receive a vote prop whose value is a callback function.
The component invokes that function when the user clicks on one of the buttons. But we haven't
actually supplied the callback yet - except in unit tests.

What should actually happen when a user votes on something? Well, the vote should probably be sent to
the server, and that's something we'll discuss a bit later, but there's also client-side logic
involved: The hasVoted prop should be set on the component, so that the user can't vote for the same
pair again.
**** DONE Prepare Unit test for hasVoted
***** TEST U1
This will be the second client-side Redux action we have, after SET_STATE. We can call it VOTE. It
should populate a hasVoted entry in the state Map:

test/reducer_spec.js
it('handles VOTE by setting hasVoted', () => {
  const state = fromJS({
    vote: {
      pair: ['Trainspotting', '28 Days Later'],
      tally: {Trainspotting: 1}
    }
  });
  const action = {type: 'VOTE', entry: 'Trainspotting'};
  const nextState = reducer(state, action);

  expect(nextState).to.equal(fromJS({
    vote: {
      pair: ['Trainspotting', '28 Days Later'],
      tally: {Trainspotting: 1}
    },
    hasVoted: 'Trainspotting'
  }));
});

***** TEST U2
It might also be a good idea to not set that entry if, for any reason, a VOTE action is coming in for
an entry that's not under vote at the moment:

test/reducer_spec.js
it('does not set hasVoted for VOTE on invalid entry', () => {
  const state = fromJS({
    vote: {
      pair: ['Trainspotting', '28 Days Later'],
      tally: {Trainspotting: 1}
    }
  });
  const action = {type: 'VOTE', entry: 'Sunshine'};
  const nextState = reducer(state, action);

  expect(nextState).to.equal(fromJS({
    vote: {
      pair: ['Trainspotting', '28 Days Later'],
      tally: {Trainspotting: 1}
    }
  }));
});
**** DONE Code in reducer
Here's the reducer extension that'll do the trick:

src/reducer.js
import {Map} from 'immutable';

function setState(state, newState) {
  return state.merge(newState);
}

function vote(state, entry) {
  const currentPair = state.getIn(['vote', 'pair']);
  if (currentPair && currentPair.includes(entry)) {
    return state.set('hasVoted', entry);
  } else {
    return state;
  }
}

export default function(state = Map(), action) {
  switch (action.type) {
  case 'SET_STATE':
    return setState(state, action.state);
  case 'VOTE':
    return vote(state, action.entry);
  }
  return state;
}
**** DONE Re-set HASVOTED
The hasVoted entry should not remain in the state forever. It should be re-set when the vote moves on
to the next pair, so that the user can vote on that one. We should handle this in SET_STATE, where we
can check if the pair in the new state contains the entry the user has voted on. If it doesn't, we
should erase the hasVoted entry:

test/reducer_spec.js
it('removes hasVoted on SET_STATE if pair changes', () => {
  const initialState = fromJS({
    vote: {
      pair: ['Trainspotting', '28 Days Later'],
      tally: {Trainspotting: 1}
    },
    hasVoted: 'Trainspotting'
  });
  const action = {
    type: 'SET_STATE',
    state: {
      vote: {
        pair: ['Sunshine', 'Slumdog Millionaire']
      }
    }
  };
  const nextState = reducer(initialState, action);

  expect(nextState).to.equal(fromJS({
    vote: {
      pair: ['Sunshine', 'Slumdog Millionaire']
    }
  }));
});

We can implement this by composing another function, called resetVote on the SET_STATE action handler:

src/reducer.js
import {List, Map} from 'immutable';

function setState(state, newState) {
  return state.merge(newState);
}

function vote(state, entry) {
  const currentPair = state.getIn(['vote', 'pair']);
  if (currentPair && currentPair.includes(entry)) {
    return state.set('hasVoted', entry);
  } else {
    return state;
  }
}

function resetVote(state) {
  const hasVoted = state.get('hasVoted');
  const currentPair = state.getIn(['vote', 'pair'], List());
  if (hasVoted && !currentPair.includes(hasVoted)) {
    return state.remove('hasVoted');
  } else {
    return state;
  }
}

export default function(state = Map(), action) {
  switch (action.type) {
  case 'SET_STATE':
    return resetVote(setState(state, action.state));
  case 'VOTE':
    return vote(state, action.entry);
  }
  return state;
}

This logic for determining whether the hasVoted entry is for the current pair is slightly problematic.
See the exercises for a way to improve it. 

**** DONE Connecting the hasVoted entry to the props on Voting

src/components/Voting.jsx
function mapStateToProps(state) {
  return {
    pair: state.getIn(['vote', 'pair']),
    hasVoted: state.get('hasVoted'),
    winner: state.get('winner')
  };
}

Now we still need a way to give a vote callback to Voting, which will cause this new action to be
dispatched. We should keep Voting itself pure and unaware of actions or Redux. Instead, this is
another job for the connect function from react-redux.
**** DONE Test Results 
#+BEGIN_SRC sh :results verbatim
npm run test 
#+END_SRC

#+RESULTS:
#+begin_example

> voting-client@1.0.0 test /usr/local/src/jstutorials/voting-client
> mocha --compilers js:babel-core/register --require ./test/test_helper.js 'test/**/*.@(js|jsx)'



  Results
    ✓ renders entries with vote counts or zero (40ms)
    ✓ invokes the next callback when next button is clicked
    ✓ renders the winner when there is one

  Voting
    ✓ renders a poir of buttons
    ✓ invokes callback when a button is clicked
    ✓ disable buttons when user has voted
    ✓ adds label to the voted entry
    ✓ renders just the winner when there is one
    ✓ renders as a pure component
    ✓ does update DOM when prop changes

  reducer
    ✓ handles SET_STATE
    ✓ handles SET_STATE with plain JS payload
    ✓ handles SET_STATE without initial state
    ✓ handles VOTE by setting hasVoted
    ✓ does not set hasVoted for VOTE on invalid entry
    ✓ removes hasVoted on SET_STATE if pair changes


  16 passing (187ms)

#+end_example

*** DONE Action Createtor
    CLOCK: [2015-11-28 Sat 21:58]--[2015-11-28 Sat 22:09] =>  0:11
    :PROPERTIES:
    :Effort:   0:05
    :END:

In addition to wiring up input props, react-redux can be used to wire up output actions. Before we can
do that though, we need to introduce another core Redux concept: Action creators.

As we have seen, Redux actions are just simple objects that (by convention) have a type attribute and
other, action-specific data. We have been creating these actions whenever needed by simply using
object literals. It is preferable, however, to use little factory functions for making actions
instead. Functions such as this one:

function vote(entry) {
  return {type: 'VOTE', entry};
}

**** DONE Action Creators
These functions are called action creators. There's really not much to them - they are pure functions
that just return action objects - but what they do is encapsulate the internal structure of the action
objects so that the rest of your codebase doesn't need to be concerned with that. Actions creators
also conveniently document all the actions that can be dispatched in a given application. That
information would be more difficult to gather if it was sprinkled all over the codebase in object
literals.

Let's create a new file that defines the action creators for our two existing client-side actions:

src/action_creators.js
export function setState(state) {
  return {
    type: 'SET_STATE',
    state
  };
}

export function vote(entry) {
  return {
    type: 'VOTE',
    entry
  };
}

We could also very easily write unit tests for these functions, but I usually don't bother with that
unless an action creator actually does something more than just returns an object. Feel free to add
the unit tests, however, if you consider them useful! 
**** DONE Applying 
In index.jsx we can now use the setState action creator in the Socket.io event handler:

src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Router, {Route} from 'react-router';
import {createStore} from 'redux';
import {Provider} from 'react-redux';
import io from 'socket.io-client';
import reducer from './reducer';
import {setState} from './action_creators';
import App from './components/App';
import {VotingContainer} from './components/Voting';
import {ResultsContainer} from './components/Results';

const store = createStore(reducer);

const socket = io(`${location.protocol}//${location.hostname}:8090`);
socket.on('state', state =>
  store.dispatch(setState(state))
);

const routes = <Route component={App}>
  <Route path="/results" component={ResultsContainer} />
  <Route path="/" component={VotingContainer} />
</Route>;

ReactDOM.render(
  <Provider store={store}>
    <Router>{routes}</Router>
  </Provider>,
  document.getElementById('app')
);

**** DONE Action Creator in action 
A really neat thing about action creators is the way react-redux can connect them to React components:
We have a vote callback prop on Voting, and a vote action creator. Both have the same name and the
same function signature: A single argument, which is the entry being voted. What we can do is simply
give our action creators to the react-redux connect function as the second argument, and the
connection will be made:

src/components/Voting.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';
import {connect} from 'react-redux';
import Winner from './Winner';
import Vote from './Vote';
import * as actionCreators from '../action_creators';

export const Voting = React.createClass({
  mixins: [PureRenderMixin],
  render: function() {
    return <div>
      {this.props.winner ?
        <Winner ref="winner" winner={this.props.winner} /> :
        <Vote {...this.props} />}
    </div>;
  }
});

function mapStateToProps(state) {
  return {
    pair: state.getIn(['vote', 'pair']),
    hasVoted: state.get('hasVoted'),
    winner: state.get('winner')
  };
}

export const VotingContainer = connect(
  mapStateToProps,
  actionCreators
)(Voting);

The effect of this is that a vote prop will be given to Voting. That prop is a function that creates
an action using the vote action creator, and also dispatches that action to the Redux Store. Thus,
clicking a vote button now dispatches an action! You should be able to see the effects in the browser
immediately: When you vote on something, the buttons will become disabled.

** TODAY Sending Actions To The Server Using Redux Middleware 
   CLOCK: [2015-11-28 Sat 23:08]--[2015-11-28 Sat 23:16] =>  0:08
   CLOCK: [2015-11-28 Sat 22:14]--[2015-11-28 Sat 22:42] =>  0:28
   :PROPERTIES:
   :Effort:   0:30
   :END:

The final aspect of our application that we need to address is getting the results of the user's
actions to the server. This should happen when the user votes on something, as well as when the vote
manager hits the Next button on the result screen.

Let's begin by discussing Voting. Here's an inventory of what we already have in place:

*** A VOTE action is created and dispatched to the client-side Redux Store when the user votes. 
*** VOTE actions are handled by the client-side reducer by setting the hasVoted state. 
*** The server is ready to receive actions from clients via the action Socket.io event. It dispatches
  all received actions to the serverside Redux Store. 
*** VOTE actions are handled by the serverside reducer by registering the vote and updating the tally. 

It would seem like we actually have almost everything we need! All that is missing is the actual
sending of the client-side VOTE action to the server, so that it would be dispatched to both of the
Redux stores. That's what we'll do next.

How should we approach this? There's nothing built into Redux for this purpose, since supporting a
distributed system like ours isn't really part of its core functionality. It is left to us to decide
where and how we send client-side actions to the server.

What Redux does provide is a generic way to tap into actions that are being dispatched to Redux
stores: Middleware.
*** Middleware 
**** Defination
A Redux middleware is a function that gets invoked when an action is dispatched, before the action
hits the reducer and the store itself. Middleware can be used for all kinds of things, from logging
and exception handling to modifying actions, caching results, or even changing how or when the action
will reach the store. What we are going to use them for is sending client-side actions to the server.

Note the difference between Redux middleware and Redux listeners: Middleware are called before an
action hits the store, and they may affect what happens to the action. Listeners are called after an
action has been dispatched, and they can't really do anything about it. Different tools for different
purposes. 
***** TEST outbound socket io Middleware 
What we're going to do is create a "remote action middleware" that causes an action to be dispatched
not only to the original store, but also to a remote store using a Socket.io connection.

Let's set up the skeleton for this middleware. It is a function that takes a Redux store, and returns
another function that takes a "next" callback. That function returns a third function that takes a
Redux action. The innermost function is where the middleware implementation will actually go:

src/remote_action_middleware.js
export default store => next => action => {

}

The code above may look a bit foreign but it's really just a more concise way of expressing this:

export default function(store) {
  return function(next) {
    return function(action) {

    }
  }
}

This style of nesting single-argument functions is called currying. In this case it's used so that the
Middleware is easily configurable: If we had all the arguments in just one function (function(store,
next, action) { }) we'd also have to supply all the arguments every time the middleware is used. With
the curried version we can call the outermost function once, and get a return value that "remembers"
which store to use. The same goes for the next argument.

The next argument is a callback that the middleware should call when it has done its work and the
action should be sent to the store (or the next middleware):

src/remote_action_middleware.js
export default store => next => action => {
  return next(action);
}

The middleware could also decide not to call next, if it decided that the action should be halted. In
that case it would never go into the reducer or the store. 

**** TEST Applly log in middleware
Let's just log something in this middleware so that we'll be able to see when it's called:

src/remote_action_middleware.js
export default store => next => action => {
  console.log('in middleware', action);
  return next(action);
}

If we now plug in this middleware to our Redux store, we should see all actions being logged. The
middleware can be activated using an applyMiddleware function that Redux ships with. It takes the
middleware we want to register, and returns a function that takes the createStore function. That
second function will then create a store for us that has the middleware included in it:

src/components/index.jsx
import React from 'react';
import ReactDOM from 'react-dom';
import Router, {Route} from 'react-router';
import {createStore, applyMiddleware} from 'redux';
import {Provider} from 'react-redux';
import io from 'socket.io-client';
import reducer from './reducer';
import {setState} from './action_creators';
import remoteActionMiddleware from './remote_action_middleware';
import App from './components/App';
import {VotingContainer} from './components/Voting';
import {ResultsContainer} from './components/Results';

const createStoreWithMiddleware = applyMiddleware(
  remoteActionMiddleware
)(createStore);
const store = createStoreWithMiddleware(reducer);

const socket = io(`${location.protocol}//${location.hostname}:8090`);
socket.on('state', state =>
  store.dispatch(setState(state))
);

const routes = <Route component={App}>
  <Route path="/results" component={ResultsContainer} />
  <Route path="/" component={VotingContainer} />
</Route>;

ReactDOM.render(
  <Provider store={store}>
    <Router>{routes}</Router>
  </Provider>,
  document.getElementById('app')
);

This is another instance of the curried style of configuring things that we just discussed. Redux APIs
use it quite heavily. 


   
**** TEST Passing socket io to middleware
If you now reload the app, you'll see the middleware logging the actions that occur: Once for the
initial SET_STATE, and again for the VOTE action from voting.

What this middleware should actually do is send a given action to a Socket.io connection, in addition
to giving it to the next middleware. Before it can do that, it needs the connection to send it to. We
already have a connection in index.jsx - we just need the middleware to have access to it too. That's
easily accomplished by using currying once more in the middleware definition. The outermost function
should take a Socket.io socket:

src/remote_action_middleware.js
export default socket => store => next => action => {
  console.log('in middleware', action);
  return next(action);
}

Now we can pass in the socket from index.jsx:

src/index.jsx
const socket = io(`${location.protocol}//${location.hostname}:8090`);
socket.on('state', state =>
  store.dispatch(setState(state))
);

const createStoreWithMiddleware = applyMiddleware(
  remoteActionMiddleware(socket)
)(createStore);
const store = createStoreWithMiddleware(reducer);

Note that we need to flip around the initialization of the socket and the store, so that the socket is
created first. We need it during store initialization.

All that remains to be done now is to actually emit an action event from the middleware:

src/remote_action_middleware.js
export default socket => store => next => action => {
  socket.emit('action', action);
  return next(action);
}

And that's it! If you now click on one of the voting buttons, you'll also see the tally numbers
update, both within the same browser window and any other ones that you run the app in. The vote is
being registered!
**** TEST Optimizaion 
There is one major problem we have with this though: When we get the state update from the server and
dispatch the SET_STATE action, it also goes right back to the server. Although the server does nothing
with that action, its listener is still triggered, causing a new SET_STATE. We have created an
infinite loop! That's certainly not good.

It is not appropriate for the remote action middleware to send each and every action to the server.
Some actions, such as SET_STATE, should just be handled locally in the client. We can extend the
middleware to only send certain actions to the server. Concretely, we should only send out actions
that have a {meta: {remote: true}} property attached:

This pattern is adapted from the rafScheduler example in the middleware documentation. 

src/remote_action_middleware.js
export default socket => store => next => action => {
  if (action.meta && action.meta.remote) {
    socket.emit('action', action);
  }
  return next(action);
}

The action creator for VOTE should now set this property, where as the one for SET_STATE should not:

src/action_creators.js
export function setState(state) {
  return {
    type: 'SET_STATE',
    state
  };
}

export function vote(entry) {
  return {
    meta: {remote: true},
    type: 'VOTE',
    entry
  };
}

Let's recap what's actually happening here:

1 The user clicks a vote button. A VOTE action is dispatched. 
2 The remote action middleware sends the action over the Socket.io connection. 
3 The client-side Redux store handles the action, causing the local hasVote state to be set. 
4 When the message arrives on the server, the serverside Redux store handles the action, updating the
  vote in the tally. 
5 The listener on the serverside Redux store broadcasts a state snapshot to all connected clients. 
6 A SET_STATE action is dispatched to the Redux store of every connected client. 
7 The Redux store of every connected client handles the SET_STATE action with the updated state from
  the server. 

To complete our application, we just need to make the Next button work as well. Just like with voting,
the server has the appropriate logic already. We just need to connect things up.
**** TEST action creator for NEXT 
The action creator for NEXT needs to create a remote action of the correct type:

src/action_creator.js
export function setState(state) {
  return {
    type: 'SET_STATE',
    state
  };
}

export function vote(entry) {
  return {
    meta: {remote: true},
    type: 'VOTE',
    entry
  };
}

export function next() {
  return {
    meta: {remote: true},
    type: 'NEXT'
  };
}

The ResultsContainer component should connect the action creators in as props:

src/components/Results.jsx
import React from 'react';
import PureRenderMixin from 'react-addons-pure-render-mixin';
import {connect} from 'react-redux';
import Winner from './Winner';
import * as actionCreators from '../action_creators';

export const Results = React.createClass({
  mixins: [PureRenderMixin],
  getPair: function() {
    return this.props.pair || [];
  },
  getVotes: function(entry) {
    if (this.props.tally && this.props.tally.has(entry)) {
      return this.props.tally.get(entry);
    }
    return 0;
  },
  render: function() {
    return this.props.winner ?
      <Winner ref="winner" winner={this.props.winner} /> :
      <div className="results">
        <div className="tally">
          {this.getPair().map(entry =>
            <div key={entry} className="entry">
              <h1>{entry}</h1>
              <div className="voteCount">
                {this.getVotes(entry)}
              </div>
            </div>
          )}
        </div>
        <div className="management">
          <button ref="next"
                   className="next"
                   onClick={this.props.next}>
            Next
          </button>
        </div>
      </div>;
  }
});

function mapStateToProps(state) {
  return {
    pair: state.getIn(['vote', 'pair']),
    tally: state.getIn(['vote', 'tally']),
    winner: state.get('winner')
  }
}

export const ResultsContainer = connect(
  mapStateToProps,
  actionCreators
)(Results);

And... that's it! We now have a complete, functioning application. Try opening the results screen on
your computer and the voting screen on a mobile device. You'll see the actions applied on one device
immediately taking effect on another - which always feel magical: Vote on one screen, see the results
view update on another screen. Click "Next" on the results screen and see the vote proceed on your
voting device. To make it even more fun, arrange a vote with some friends the next time you get
together!

* Exercises 
** 1. Invalid Vote Prevention 
** 2. Improved Vote State Reset 
** 3. Duplicate Vote Prevention 
** 4. Restarting The Vote 
** 5. Indicating Socket Connection State 
** Bonus Challenge: Going Peer to Peer 
*** Loading Entries 
*** Starting The Vote 
*** Voting 
*** Moving to The Next Pair 
*** Ending The Vote 

** Introducing Actions and Reducers 
** A Taste of Reducer Composition 
** Introducing The Redux Store 
** Setting Up a Socket.io Server 
** Broadcasting State from A Redux Listener 
** Receiving Remote Redux Actions 

 
